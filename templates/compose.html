<roundcube:include file="includes/layout.html" />
<roundcube:include file="includes/menu.html" condition="!env:extwin && !env:framed" />
<roundcube:add_label name="recipientsadded" />
<roundcube:add_label name="nocontactselected" />
<roundcube:add_label name="recipient" />
<roundcube:add_label name="insert" />
<roundcube:add_label name="insertcontact" />
<roundcube:add_label name="recipientedit" />

<h1 class="voice"><roundcube:label name="compose" /></h1>
<!-- compose options and attachments list -->
<div id="layout-sidebar" class="listbox sidebar-right">
	<div class="header">
		<a class="button icon back-content-button" href="#content" data-hidden="big"><span class="inner"><roundcube:label name="back" /></span></a>
		<span class="header-title all-sizes"><roundcube:label name="optionsandattachments" /></span>
	</div>
	<div class="scroller">
		<!-- attachments -->
		<div id="compose-attachments" class="file-upload" role="region" aria-labelledby="aria-label-compose-attachments">
			<h2 id="aria-label-compose-attachments" class="voice"><roundcube:label name="attachments" /></h2>
			<div class="upload-form">
				<roundcube:object name="composeAttachmentForm" mode="hint" />
				<button type="button" class="btn btn-secondary attach" tabindex="2" onclick="rcmail.upload_input('uploadform')"><roundcube:label name="addattachment" /></button>
			</div>
			<roundcube:object name="composeAttachmentList" id="attachment-list" class="attachmentslist" tabindex="2" />
			<roundcube:object name="fileDropArea" id="compose-attachments" />
		</div>
		<!-- compose options -->
		<div id="compose-options" class="formcontent" role="region" aria-labelledby="aria-label-composeoptions">
			<h2 id="aria-label-composeoptions" class="voice"><roundcube:label name="arialabelcomposeoptions" /></h2>
			<roundcube:container name="composeoptions" id="compose-options" />
			<roundcube:if condition="!in_array('mdn_default', (array)config:dont_override)" />
			<div class="form-group row form-check">
				<label for="compose-mdn" class="col-form-label col-6"><roundcube:label name="returnreceipt" /></label>
				<div class="col-6 form-check">
					<roundcube:object name="mdnCheckBox" id="compose-mdn" noform="true" tabindex="2" class="form-check-input" />
				</div>
			</div>
			<roundcube:endif />
			<roundcube:if condition="!in_array('dsn_default', (array)config:dont_override)" />
			<div class="form-group row form-check">
				<label for="compose-dsn" class="col-form-label col-6"><roundcube:label name="dsn" /></label>
				<div class="col-6 form-check">
					<roundcube:object name="dsnCheckBox" id="compose-dsn" noform="true" tabindex="2" class="form-check-input" />
				</div>
			</div>
			<roundcube:endif />
			<div class="form-group row">
				<label for="compose-priority" class="col-form-label col-6"><roundcube:label name="priority" /></label>
				<div class="col-6">
					<roundcube:object name="prioritySelector" id="compose-priority" noform="true" tabindex="2" class="dropdown" />
				</div>
			</div>
			<roundcube:if condition="!config:no_save_sent_messages" />
			<div class="form-group row">
				<label for="compose-store-target" class="col-form-label col-6"><roundcube:label name="savesentmessagein" /></label>
				<div class="col-6">
					<roundcube:object name="storetarget" id="compose-store-target" noform="true" tabindex="2" class="dropdown" />
				</div>
			</div>
			<roundcube:endif />
		</div>
	</div>
</div>

<div id="layout-content" class="listbox selected" role="main">
	<h2 id="aria-label-toolbar" class="voice"><roundcube:label name="arialabeltoolbar" /></h2>
	<div class="header">
		<a class="button icon task-menu-button" href="#menu"><span class="inner"><roundcube:label name="menu" /></span></a>
		<span class="header-title"><roundcube:label name="compose" /></span>
		<div id="composestatusbar" class="position-absolute"></div>
		<!-- toolbar -->
		<div id="messagetoolbar" class="toolbar menu" role="toolbar" aria-labelledby="aria-label-toolbar">
			<a class="options" href="#options" onclick="UI.show_sidebar()" data-hidden="big">
				<span class="inner"><roundcube:label name="optionsandattachments"></span>
			</a>
			<roundcube:button command="savedraft" type="link" class="save draft disabled" classAct="save draft"
				label="save" title="savemessage" tabindex="2" innerclass="inner" data-content-button="true" />
			<span class="spacer"></span>
			<roundcube:button name="addattachment" type="link" class="attach"
				label="attach" title="addattachment" data-hidden="small"
				onclick="if (!$(this).is('.disabled')) rcmail.upload_input('uploadform')"
				aria-haspopup="true" aria-expanded="false" tabindex="2" innerclass="inner" />
			<roundcube:button command="insert-sig" type="link" class="signature disabled" classAct="signature"
				label="signature" title="insertsignature" tabindex="2" innerclass="inner" />
			<a href="#responses" class="responses" label="responses" title="<roundcube:label name='insertresponse' />" unselectable="on" tabindex="2" data-popup="responses-menu">
				<span class="inner"><roundcube:label name="responses" /></span>
			</a>
			<span class="dropbutton" style="display:none">
				<roundcube:button command="compose-encrypted" type="link" class="encrypt disabled"
					classAct="encrypt" classSel="encrypt selected" innerclass="inner"
					label="encrypt" title="encryptmessagemailvelope" tabindex="2" />
				<a href="#encryption" id="encryption-menu-button" class="dropdown" tabindex="2" data-popup="encryption-menu">
					<span class="inner"><roundcube:label name="encryptmessagemailvelope" /></span>
				</a>
			</span>
			<roundcube:container name="toolbar" id="compose-toolbar" />
		</div>
	</div>
	<div id="compose-content" class="formcontainer content">
		<roundcube:object name="composeFormHead" role="main" class="formcontent scroller" />
		<roundcube:object name="composeObjects" id="compose-objects" class="mb-3" />
		<!-- message headers -->
		<div id="compose-headers" role="region" aria-labelledby="aria-label-composeheaders">
			<h2 id="aria-label-composeheaders" class="voice"><roundcube:label name="arialabelmessageheaders" /></h2>
			<div class="compose-headers">
				<div id="compose_from" class="form-group row">
					<label for="_from" class="col-2 col-form-label"><roundcube:label name="from" /></label>
					<div class="col-10">
						<div class="input-group">
							<roundcube:object name="composeHeaders" part="from" id="_from" form="form" tabindex="1" class="form-control" />
							<span class="input-group-append">
								<a href="#identities" onclick="return rcmail.command('switch-task', 'settings/identities')" class="input-group-text icon edit" title="<roundcube:label name="editidents" />" tabindex="1"><span class="inner"><roundcube:label name="editidents" /></span></a>
							</span>
						</div>
					</div>
				</div>
				<div id="compose_to" class="form-group row">
					<label for="_to" class="col-2 col-form-label"><roundcube:label name="to" /></label>
					<div class="col-10">
						<div class="input-group">
							<roundcube:object name="composeHeaders" part="to" id="_to" form="form" tabindex="1" aria-required="true" data-recipient-input="true" />
							<span class="input-group-append">
								<a href="#add-contact" onclick="UI.recipient_selector('to')" class="input-group-text icon add recipient" title="<roundcube:label name="addcontact" />" tabindex="1"><span class="inner"><roundcube:label name="addcontact" /></span></a>
							</span>
							<span class="input-group-append">
								<a href="#add-header" data-popup="headers-menu" class="input-group-text icon add" title="<roundcube:label name="addheader" />" tabindex="1"><span class="inner"><roundcube:label name="addheader" /></span></a>
							</span>
						</div>
					</div>
				</div>
				<div id="compose_cc" class="hidden form-group row">
					<label for="_cc" class="col-2 col-form-label"><roundcube:label name="cc" /></label>
					<div class="col-10">
						<div class="input-group">
							<roundcube:object name="composeHeaders" part="cc" id="_cc" form="form" tabindex="1" data-recipient-input="true" />
							<span class="input-group-append">
								<a href="#add-contact" onclick="UI.recipient_selector('cc')" class="input-group-text icon add recipient" title="<roundcube:label name="addcontact" />" tabindex="1"><span class="inner"><roundcube:label name="addcontact" /></span></a>
							</span>
							<span class="input-group-append">
								<a href="#delete" onclick="UI.header_reset('_cc')" class="input-group-text icon delete" title="<roundcube:label name='delete' />" tabindex="1"><span class="inner"><roundcube:label name="delete" /></span></a>
							</span>
						</div>
					</div>
				</div>
				<div id="compose_bcc" class="hidden form-group row">
					<label for="_bcc" class="col-2 col-form-label"><roundcube:label name="bcc" /></label>
					<div class="col-10">
						<div class="input-group">
							<roundcube:object name="composeHeaders" part="bcc" id="_bcc" form="form" tabindex="1" data-recipient-input="true" />
							<span class="input-group-append">
								<a href="#add-contact" onclick="UI.recipient_selector('bcc')" class="input-group-text icon add recipient" title="<roundcube:label name="addcontact" />" tabindex="1"><span class="inner"><roundcube:label name="addcontact" /></span></a>
							</span>
							<span class="input-group-append">
								<a href="#delete" onclick="UI.header_reset('_bcc')" class="input-group-text icon delete" title="<roundcube:label name='delete' />" tabindex="1"><span class="inner"><roundcube:label name="delete" /></span></a>
							</span>
						</div>
					</div>
				</div>
				<div id="compose_replyto" class="hidden form-group row">
					<label for="_replyto" class="col-2 col-form-label"><roundcube:label name="replyto" /></label>
					<div class="col-10">
						<div class="input-group">
							<roundcube:object name="composeHeaders" part="replyto" id="_replyto" form="form" tabindex="1" data-recipient-input="true" />
							<span class="input-group-append">
								<a href="#add-contact" onclick="UI.recipient_selector('replyto')" class="input-group-text icon add recipient" title="<roundcube:label name="addcontact" />" tabindex="1"><span class="inner"><roundcube:label name="addcontact" /></span></a>
							</span>
							<span class="input-group-append">
								<a href="#delete" onclick="UI.header_reset('_replyto')" class="input-group-text icon delete" title="<roundcube:label name='delete' />" tabindex="1"><span class="inner"><roundcube:label name="delete" /></span></a>
							</span>
						</div>
					</div>
				</div>
				<div id="compose_followupto" class="hidden form-group row">
					<label for="_followupto" class="col-2 col-form-label"><roundcube:label name="followupto" /></label>
					<div class="col-10">
						<div class="input-group">
							<roundcube:object name="composeHeaders" part="followupto" id="_followupto" form="form" tabindex="1" data-recipient-input="true" />
							<span class="input-group-append">
								<a href="#add-contact" onclick="UI.recipient_selector('followupto')" class="input-group-text icon add recipient" title="<roundcube:label name="addcontact" />" tabindex="1"><span class="inner"><roundcube:label name="addcontact" /></span></a>
							</span>
							<span class="input-group-append">
								<a href="#delete" onclick="UI.header_reset('_followupto')" class="input-group-text icon delete" title="<roundcube:label name='delete' />" tabindex="1"><span class="inner"><roundcube:label name="delete" /></span></a>
							</span>
						</div>
					</div>
				</div>
				<div id="compose_subject" class="form-group row">
					<label for="compose-subject" class="col-2 col-form-label"><roundcube:label name="subject" /></label>
					<div class="col-10">
						<roundcube:object name="composeSubject" id="compose-subject" form="form" tabindex="1" class="form-control" />
					</div>
				</div>
			</div>
		</div>
		<!-- message compose body -->
		<div id="composebodycontainer">
			<label for="composebody" class="voice"><roundcube:label name="arialabelmessagebody" /></label>
			<roundcube:object name="composeBody" id="composebody" form="form" cols="70" rows="20" class="form-control" tabindex="1" />
			<roundcube:if condition="!in_array('htmleditor', (array)config:dont_override)" />
			<roundcube:object name="editorSelector" id="editor-selector" editorid="composebody" noform="true" class="hidden" />
			<roundcube:endif />
		</div>
		</form>
		<div class="formbuttons">
			<roundcube:button command="send" class="btn btn-primary send" label="send" tabindex="1" data-content-button="true" />
			<button id="schedule-send-button" data-toggle="modal" data-target="#schedule-send-modal" onclick="generateScheduleOptions()" tabindex="1" class="btn btn-secondary" style="cursor: pointer;">
				<span class="icon">
					<i class="fa-regular fa-clock"></i>
				</span>
				<span>Schedule Send</span>
			</button>
			<button id="templates-button" data-toggle="modal" data-target="#template-modal" onclick="getTemplates()" tabindex="1" class="btn btn-secondary" style="cursor: pointer;">
				<span class="icon">
					<i class="fa-solid fa-file"></i>
				</span>
				<span>Templates</span>
			</button>
			<button id="auto-draft-button" data-toggle="modal" data-target="#auto-draft-modal" tabindex="1" class="btn btn-secondary" style="cursor: pointer; background-image: linear-gradient(90deg, #00ceb1 0%, #1E92FB 100%);">
				<span class="icon">
					<i class="fa-solid fa-wand-magic-sparkles"></i>
				</span>
				<span id="ai-draft-text">AI draft</span>
			</button>
			
			<div class="float-right">
				<roundcube:button command="extwin" type="link" label="openinextwin" data-hidden="small" class="button icon btn btn-link extwin" data-tabindex="1" condition="!env:extwin" />
			</div>
		</div>
	</div>
</div>

<roundcube:object name="composeAttachmentForm" id="uploadform" mode="smart" />

<div id="spell-menu" class="popupmenu" data-popup-init="spellmenu"></div>

<div id="headers-menu" class="popupmenu" data-popup-init="headersmenu">
	<h3 id="aria-label-headersmenu" class="voice"><roundcube:label name="arialabelheadersmenu" /></h3>
	<ul class="menu listing" role="menu" aria-labelledby="aria-label-headersmenu">
		<li role="menuitem"><a data-target="cc" href="#" role="button" tabindex="-1" class="recipient active"><roundcube:label name="cc" /></a></li>
		<li role="menuitem"><a data-target="bcc" href="#" role="button" tabindex="-1" class="recipient active"><roundcube:label name="bcc" /></a></li>
		<li role="menuitem"><a data-target="replyto" href="#" role="button" tabindex="-1" class="recipient active"><roundcube:label name="replyto" /></a></li>
		<li role="menuitem"><a data-target="followupto" href="#" role="button" tabindex="-1" class="recipient active"><roundcube:label name="followupto" /></a></li>
	</ul>
</div>

<div id="responses-menu" class="popupmenu">
	<h3 id="aria-label-responsesmenu" class="voice"><roundcube:label name="arialabelresponsesmenu" /></h3>
	<ul class="menu listing" role="menu" aria-labelledby="aria-label-responsesmenu">
		<li role="separator" class="separator"><label><roundcube:label name="insertresponse" /></label></li>
		<roundcube:object name="responseslist" id="responseslist" tagname="ul" class="rounded-0" itemclass="active" list-placeholder="noresponsesavailable" />
		<li role="separator" class="separator"><label><roundcube:label name="manageresponses" /></label></li>
		<roundcube:button command="save-response" type="link-menuitem" label="newresponse" class="create responses disabled" classAct="create responses active" unselectable="on" />
		<roundcube:button name="responses" type="link-menuitem" label="editresponses" class="edit responses active" onclick="return rcmail.command('switch-task', 'settings/responses')" />
	</ul>
</div>

<div id="attachmentmenu" class="popupmenu">
	<h3 id="aria-label-attachmentmenu" class="voice"><roundcube:label name="arialabelattachmentmenu" /></h3>
	<ul class="menu listing" role="menu" aria-labelledby="aria-label-attachmentmenu">
		<roundcube:button command="open-attachment" id="attachmenuopen" type="link-menuitem" label="open" class="extwin disabled" classAct="extwin active" />
		<roundcube:button command="download-attachment" id="attachmenudownload" type="link-menuitem" label="download" class="download disabled" classAct="download active" />
		<roundcube:button command="rename-attachment" id="attachmenurename" type="link-menuitem" label="rename" class="rename disabled" classAct="rename active" />
		<roundcube:container name="attachmentmenu" id="attachmentoptionsmenu" />
	</ul>
</div>

<div id="encryption-menu" class="popupmenu">
	<ul class="menu listing" role="menu">
		<roundcube:button command="compose-encrypted" type="link-menuitem" label="encryptmessage" class="encrypt disabled" classAct="encrypt active" />
		<roundcube:button command="compose-encrypted-signed" type="link-menuitem" label="encryptandsign" class="encrypt sign disabled" classAct="encrypt sign active" />
	</ul>
</div>

<div id="recipient-dialog" class="popupmenu" role="region" aria-labelledby="aria-label-composecontacts">
	<div class="listbox">
		<roundcube:object name="searchform" id="searchform" wrapper="searchbar menu"
			label="contactsearchform" buttontitle="findcontacts" ariatag="h2" class="no-bs" />
		<div class="scroller" tabindex="-1">
			<roundcube:object name="addressbooks" id="directorylist" class="treelist listing iconized"
				summary="ariasummarycomposecontacts" />
			<roundcube:object name="addresslist" id="contacts-table" class="listing iconized contactlist"
				noheader="true" role="listbox" data-list="contact_list" data-list-select-replace="#recipient-dialog .pagenav-text" />
		</div>
		<roundcube:include file="includes/pagenav.html" />
	</div>
</div>

<script src="https://kit.fontawesome.com/3e4542b30a.js" crossorigin="anonymous"></script>
<script>
	const phrases = [
		"Request a meeting with a colleague",
		"Ask for a project update",
		"Apologize for missing a deadline",
		"Request time off from work",
		"Follow up on an overdue invoice",
		"Inquire about a job application status",
		"Request feedback on a report",
		"Confirm a meeting time",
		"Request an extension on a project deadline",
		"Ask for clarification on a task",
		"Notify a client of a delay",
		"Request a recommendation letter",
		"Follow up on a previous email",
		"Announce a new team member",
		"Request assistance with a technical issue",
		"Thank someone for their help",
		"Provide a status update on a project",
		"Notify of a change in work hours",
		"Invite someone to a company event",
		"Request a demo of a product",
		"Confirm attendance at a meeting",
		"Express interest in a potential partnership",
		"Request approval for a budget increase",
		"Apologize for a misunderstanding",
		"Ask for input on a new proposal",
		"Notify of a policy change",
		"Request support for a new initiative",
		"Schedule a performance review",
		"Confirm a travel itinerary",
		"Request a meeting agenda",
		"Follow up on a job interview",
		"Express gratitude for a recent opportunity",
		"Inquire about training opportunities",
		"Notify of a change in contact information",
		"Request a meeting with a mentor",
		"Follow up on a product shipment",
		"Confirm receipt of an important document",
		"Request a quote for services",
		"Announce a company milestone",
		"Request feedback on a presentation",
		"Ask for clarification on company policy",
		"Follow up on a customer complaint",
		"Request a refund for a service",
		"Confirm details for an upcoming event",
		"Notify of a change in project scope",
		"Ask for an update on a grant application",
		"Request a collaboration on a project",
		"Thank a client for their business",
		"Notify of a holiday schedule",
		"Request a status report on an ongoing task",
		"Follow up on a business proposal",
		"Request confirmation for a training session",
		"Inquire about a product's availability",
		"Notify of a change in meeting location",
		"Confirm details for a partnership meeting",
		"Request assistance with a deadline",
		"Apologize for a delay in response",
		"Follow up on an email sent last week",
		"Request a meeting with a new client",
		"Confirm attendance at a workshop",
		"Request a new user account setup",
		"Notify of a change in vendor contact details",
		"Follow up on a warranty claim",
		"Ask for suggestions on a new project",
		"Confirm the delivery of important documents",
		"Request a review of a draft document",
		"Notify of a change in project team",
		"Request a follow-up meeting",
		"Apologize for a recent error",
		"Request a meeting with a business partner",
		"Inquire about potential sponsorship opportunities",
		"Confirm a reservation for a business dinner",
		"Request a status update on a marketing campaign",
		"Notify of an upcoming company retreat",
		"Request confirmation for a conference call",
		"Apologize for a missed appointment",
		"Follow up on a contract renewal",
		"Request feedback on a customer survey",
		"Notify of a new business policy",
		"Confirm details for a training workshop",
		"Request assistance with a software issue",
		"Follow up on an application for a grant",
		"Request an update on a project milestone",
		"Notify of a change in office address",
		"Confirm the receipt of a recent shipment",
		"Request a meeting to discuss a new project idea",
		"Apologize for a mistake in a previous email",
		"Request clarification on a financial report",
		"Follow up on a request for information",
		"Confirm details for an upcoming presentation",
		"Notify of a change in project deadlines",
		"Request feedback on a new product feature",
		"Ask for a review of a business plan",
		"Notify of a change in staff roles",
		"Request an update on a service request",
		"Confirm a date for a client meeting",
		"Follow up on a previous business proposal",
		"Request assistance with a project deadline",
		"Apologize for an oversight in communication",
		"Confirm attendance at a networking event",
		"Request a status report on a research project",
		"Notify of a change in product pricing",
		"Ask for a review of a new policy document",
		"Follow up on a recent meeting agenda",
		"Confirm details for an upcoming workshop",
		"Request feedback on a team performance review",
		"Notify of a change in client contact details",
		"Request an extension on a service agreement",
		"Apologize for an error in a report",
		"Confirm receipt of a payment",
		"Follow up on an application for a job",
		"Request assistance with a project task",
		"Notify of a new office location",
		"Request feedback on a business strategy",
		"Confirm attendance at a team-building event",
		"Follow up on a recent customer inquiry",
		"Request a meeting to discuss a partnership",
		"Apologize for a recent customer service issue",
		"Notify of a change in vendor policies",
		"Request assistance with a product launch",
		"Confirm details for a client presentation",
		"Follow up on an email regarding a contract",
		"Request an update on a pending approval",
		"Notify of a new company initiative",
		"Confirm a meeting time with a client",
		"Request feedback on a marketing strategy",
		"Apologize for a delay in project delivery",
		"Follow up on a customer satisfaction survey",
		"Request a status update on a grant application",
		"Notify of a change in staff availability",
		"Confirm details for an upcoming training",
		"Request a meeting to discuss budget changes",
		"Apologize for a recent oversight",
		"Follow up on a previous request for information",
		"Request feedback on a new proposal",
		"Notify of a change in project management",
		"Confirm attendance at a business seminar",
		"Request assistance with a product issue",
		"Apologize for a recent miscommunication",
		"Follow up on a request for a meeting",
		"Notify of a new business development",
		"Request confirmation for a conference registration",
		"Confirm details for a client review meeting",
		"Apologize for a recent email error",
		"Request feedback on a business report",
		"Notify of a change in service hours",
		"Follow up on a recent product order",
		"Request a meeting to discuss new opportunities",
		"Confirm receipt of a job application",
		"Apologize for a missed deadline on a report",
		"Follow up on an email regarding a proposal",
		"Request an update on a project budget",
		"Notify of a change in office policies",
		"Confirm attendance at an industry conference",
		"Request feedback on a team project",
		"Apologize for an error in a client report",
		"Follow up on a recent inquiry about services",
		"Request assistance with a new initiative",
		"Confirm details for a client meeting",
		"Notify of a change in project requirements",
		"Apologize for a recent issue with service",
		"Follow up on a request for a product demo",
		"Request a review of a recent presentation",
		"Confirm receipt of a recent shipment",
		"Apologize for a delay in responding to an email",
		"Request feedback on a proposed strategy",
		"Notify of a change in project deadlines",
		"Follow up on a recent contract negotiation",
		"Request assistance with a customer issue",
		"Confirm details for a team-building event",
		"Apologize for a recent error in communication",
		"Request feedback on a new software feature",
		"Notify of a change in service contact",
		"Follow up on a previous meeting request",
		"Request an update on a business proposal",
		"Confirm attendance at a workshop",
		"Apologize for a delay in project completion",
		"Request feedback on a new team initiative",
		"Notify of a change in project management team",
		"Follow up on a recent customer request",
		"Request a meeting to discuss a new project",
		"Apologize for a recent oversight in delivery",
		"Confirm details for a client workshop",
		"Request assistance with a service issue",
		"Notify of a change in vendor contact",
		"Follow up on a recent product complaint",
		"Request feedback on a new business process",
		"Confirm receipt of an important document",
		"Apologize for a mistake in a previous email",
		"Request a meeting to discuss a proposal",
		"Notify of a change in project timeline",
		"Follow up on a recent service inquiry",
		"Request feedback on a new training program",
		"Confirm details for an upcoming event",
		"Apologize for a recent error in scheduling",
		"Request assistance with a new client onboarding",
		"Notify of a change in office hours",
		"Follow up on a recent business meeting",
		"Request an update on a pending request",
		"Confirm receipt of a project deliverable",
		"Apologize for a delay in processing an order",
		"Request feedback on a new marketing campaign",
		"Notify of a change in team structure",
		"Follow up on a recent vendor issue",
		"Request a meeting to discuss a new proposal",
		"Confirm details for a customer presentation",
		"Apologize for a recent mistake in service",
		"Request feedback on a new product feature",
		"Notify of a change in meeting schedule",
		"Follow up on a recent customer complaint",
		"Request an update on a project deliverable",
		"Confirm receipt of a recent email",
		"Apologize for a delay in sending a report",
		"Request assistance with a client issue",
		"Notify of a change in service protocol",
		"Follow up on a recent email inquiry",
		"Request feedback on a new business initiative",
		"Confirm details for a team meeting",
		"Apologize for a recent oversight in communication",
		"Request assistance with a project update",
		"Notify of a change in vendor policies",
		"Follow up on a recent proposal review",
		"Request a meeting to discuss a budget proposal",
		"Confirm receipt of a shipment",
		"Apologize for a delay in responding to a request",
		"Request feedback on a new product launch",
		"Notify of a change in office location",
		"Follow up on a recent client inquiry",
		"Request a meeting to discuss a partnership opportunity",
		"Confirm details for a client review",
		"Apologize for a recent error in scheduling",
		"Request assistance with a customer service issue",
		"Notify of a change in project scope",
		"Follow up on a recent email regarding a contract",
		"Request feedback on a new service offering",
		"Confirm receipt of a business proposal",
		"Apologize for a delay in sending information",
		"Request a meeting to discuss a new opportunity",
		"Notify of a change in team assignments",
		"Follow up on a recent email about a job application",
		"Request assistance with a product issue",
		"Confirm details for a customer workshop",
		"Apologize for a recent mistake in communication",
		"Request feedback on a new business strategy",
		"Notify of a change in project deadlines",
		"Follow up on a recent vendor request",
		"Request a meeting to discuss a new initiative",
		"Confirm receipt of an important document",
		"Apologize for a delay in providing feedback",
		"Request assistance with a technical issue",
		"Notify of a change in business hours",
		"Follow up on a recent customer complaint",
		"Request feedback on a new policy document",
		"Confirm details for an upcoming seminar",
		"Apologize for a recent error in service",
		"Request a meeting to discuss project milestones",
		"Notify of a change in service delivery schedule",
		"Follow up on a recent request for information",
		"Request feedback on a new training session",
		"Confirm receipt of a recent email inquiry",
		"Apologize for a delay in updating a report",
		"Request assistance with a project task",
		"Notify of a change in vendor contact",
		"Follow up on a recent proposal review",
		"Request a meeting to discuss a business opportunity",
		"Confirm details for a team workshop",
		"Apologize for a recent oversight in scheduling",
		"Request feedback on a new product feature",
		"Notify of a change in office policies",
		"Follow up on a recent customer service issue",
		"Request a meeting to discuss a new proposal",
		"Confirm receipt of a shipment",
		"Apologize for a delay in project completion",
		"Request assistance with a client request",
		"Notify of a change in project management",
		"Follow up on a recent email about a contract",
		"Request feedback on a new business initiative",
		"Confirm details for a client meeting",
		"Apologize for a recent mistake in scheduling",
		"Request assistance with a service issue",
		"Notify of a change in team roles",
		"Follow up on a recent email inquiry",
		"Request a meeting to discuss a new project",
		"Confirm receipt of an important document",
		"Apologize for a delay in providing feedback",
		"Request feedback on a new service offering",
		"Notify of a change in vendor policies",
		"Follow up on a recent request for a quote",
		"Request assistance with a project update",
		"Confirm details for a customer presentation",
		"Apologize for a recent error in communication",
		"Request feedback on a new marketing strategy",
		"Notify of a change in office hours",
		"Follow up on a recent proposal",
		"Request a meeting to discuss a partnership",
		"Confirm receipt of a job application",
		"Apologize for a delay in project delivery",
		"Request assistance with a client issue",
		"Notify of a change in service protocol",
		"Follow up on a recent vendor request",
		"Request feedback on a new training program",
		"Confirm details for a business seminar",
		"Apologize for a recent error in service",
		"Request a meeting to discuss project milestones",
		"Notify of a change in project scope",
		"Follow up on a recent customer complaint",
		"Request feedback on a new policy document",
		"Confirm receipt of a shipment",
		"Apologize for a delay in sending information",
		"Request assistance with a product issue",
		"Notify of a change in team assignments",
		"Follow up on a recent email regarding a contract",
		"Request feedback on a new service offering",
		"Confirm details for a client review meeting",
		"Apologize for a recent mistake in scheduling",
		"Request assistance with a technical issue",
		"Notify of a change in office policies",
		"Follow up on a recent proposal review",
		"Request a meeting to discuss a new opportunity",
		"Confirm receipt of an important document",
		"Apologize for a delay in updating a report",
		"Request feedback on a new business strategy",
		"Notify of a change in service delivery schedule",
		"Follow up on a recent request for information",
		"Request a meeting to discuss project milestones",
		"Confirm details for a team-building event",
		"Apologize for a recent oversight in communication",
		"Request assistance with a customer service issue",
		"Notify of a change in vendor contact details",
		"Follow up on a recent email inquiry",
		"Request feedback on a new product feature",
		"Confirm receipt of a business proposal",
		"Apologize for a delay in sending a report",
		"Request a meeting to discuss a new initiative",
		"Notify of a change in project management",
		"Follow up on a recent vendor issue",
		"Request feedback on a new marketing campaign",
		"Confirm details for a customer workshop",
		"Apologize for a recent error in scheduling",
		"Request assistance with a service issue",
		"Notify of a change in team roles",
		"Follow up on a recent email about a job application",
		"Request feedback on a new business process",
		"Confirm receipt of a shipment",
		"Apologize for a delay in project completion",
		"Request assistance with a client issue",
		"Notify of a change in service protocol",
		"Follow up on a recent proposal",
		"Request feedback on a new training program",
		"Confirm details for an upcoming seminar",
		"Apologize for a recent mistake in communication",
		"Request assistance with a project update",
		"Notify of a change in office hours",
		"Follow up on a recent customer complaint",
		"Request feedback on a new policy document",
		"Confirm receipt of a business proposal",
		"Apologize for a delay in providing feedback",
		"Request assistance with a technical issue",
		"Notify of a change in team assignments",
		"Follow up on a recent request for information",
		"Request feedback on a new service offering",
		"Confirm details for a client review meeting",
		"Apologize for a recent error in scheduling",
		"Request assistance with a project milestone",
		"Notify of a change in service delivery schedule",
		"Follow up on a recent email inquiry",
		"Request feedback on a new marketing strategy",
		"Confirm receipt of a shipment",
		"Apologize for a delay in sending a report",
		"Request assistance with a client issue",
		"Notify of a change in office policies",
		"Follow up on a recent proposal review",
		"Request a meeting to discuss a new opportunity",
		"Confirm details for a business seminar",
		"Apologize for a recent mistake in communication",
		"Request feedback on a new product feature",
		"Notify of a change in team structure",
		"Follow up on a recent customer service issue",
		"Request assistance with a service issue",
		"Confirm receipt of an important document",
		"Apologize for a delay in providing feedback",
		"Request feedback on a new business strategy",
		"Notify of a change in project deadlines",
		"Follow up on a recent request for a quote",
		"Request a meeting to discuss a new proposal",
		"Confirm details for a client presentation",
		"Apologize for a recent error in service",
		"Request assistance with a project update",
		"Notify of a change in vendor contact details",
		"Follow up on a recent proposal review",
		"Request feedback on a new marketing campaign",
		"Confirm receipt of a business proposal",
		"Apologize for a delay in sending information",
		"Request assistance with a technical issue",
		"Notify of a change in office hours",
		"Follow up on a recent customer complaint",
		"Request feedback on a new policy document",
		"Confirm details for an upcoming seminar",
		"Apologize for a recent mistake in scheduling",
		"Request a meeting to discuss a new business process",
		"Notify of a change in project management",
		"Follow up on a recent request for information",
		"Request feedback on a new training program",
		"Confirm receipt of an important document",
		"Apologize for a delay in providing feedback",
		"Request assistance with a service issue",
		"Notify of a change in office policies",
		"Follow up on a recent proposal review",
		"Request feedback on a new marketing strategy",
		"Confirm details for a client review meeting",
		"Apologize for a recent error in communication",
		"Request assistance with a project milestone",
		"Notify of a change in vendor contact details",
		"Follow up on a recent customer service issue",
		"Request feedback on a new business strategy",
		"Confirm receipt of a shipment",
		"Apologize for a delay in sending a report",
		"Request assistance with a client issue",
		"Notify of a change in service protocol",
		"Follow up on a recent proposal",
		"Request feedback on a new product feature",
		"Confirm details for a business seminar",
		"Apologize for a recent mistake in scheduling",
		"Request assistance with a project update",
		"Notify of a change in office hours",
		"Follow up on a recent email inquiry",
		"Request feedback on a new training program",
		"Confirm receipt of an important document",
		"Apologize for a delay in providing feedback",
		"Request assistance with a technical issue",
		"Notify of a change in project deadlines",
		"Follow up on a recent customer complaint",
		"Request feedback on a new marketing strategy",
		"Confirm details for a client presentation",
		"Apologize for a recent error in service",
		"Request assistance with a service issue",
		"Notify of a change in team roles",
		"Follow up on a recent email about a job application",
		"Request feedback on a new policy document",
		"Confirm receipt of a shipment",
		"Apologize for a delay in sending information",
		"Request assistance with a client issue",
		"Notify of a change in office policies",
		"Follow up on a recent proposal review",
		"Request feedback on a new business process",
		"Confirm details for a team-building event",
		"Apologize for a recent mistake in scheduling",
		"Request assistance with a project milestone",
		"Notify of a change in service delivery schedule",
		"Follow up on a recent customer service issue",
		"Request feedback on a new marketing campaign",
		"Confirm receipt of a business proposal",
		"Apologize for a delay in providing feedback",
		"Request assistance with a technical issue",
		"Notify of a change in project management",
		"Follow up on a recent request for information",
		"Request feedback on a new service offering",
		"Confirm details for a client review meeting",
		"Apologize for a recent error in communication",
		"Request assistance with a service issue",
		"Notify of a change in team assignments",
		"Follow up on a recent customer complaint",
		"Request feedback on a new training program",
		"Confirm receipt of an important document",
		"Apologize for a delay in sending information",
		"Request assistance with a client issue",
		"Notify of a change in office policies",
		"Follow up on a recent proposal review",
		"Request feedback on a new marketing strategy",
		"Confirm details for a business seminar",
		"Apologize for a recent error in scheduling",
		"Request assistance with a project update",
		"Notify of a change in office hours",
		"Follow up on a recent email inquiry",
		"Request feedback on a new business strategy",
		"Confirm receipt of a shipment",
		"Apologize for a delay in sending a report",
		"Request assistance with a technical issue",
		"Notify of a change in project deadlines",
		"Follow up on a recent customer complaint",
		"Request feedback on a new marketing campaign",
		"Confirm details for a client presentation",
		"Apologize for a recent error in service",
		"Request assistance with a service issue",
		"Notify of a change in team roles",
		"Follow up on a recent job application",
		"Request feedback on a new policy document",
		"Confirm receipt of a business proposal",
		"Apologize for a delay in sending information",
		"Request assistance with a client issue",
		"Notify of a change in office policies",
		"Follow up on a recent proposal review",
		"Request feedback on a new marketing strategy",
		"Confirm details for a team-building event",
		"Apologize for a recent mistake in scheduling",
		"Request assistance with a project milestone",
		"Notify of a change in service delivery schedule",
		"Follow up on a recent customer service issue",
		"Request feedback on a new training program",
		"Confirm receipt of an important document",
	];

	const autoDraftApiURL = 'https://console.gofloww.co/api/mail/auto-draft/'
	const scheduleSendApiURL = 'https://console.gofloww.co/api/mail/schedule-send/'
	const replyAssistApiURL = 'https://console.gofloww.co/api/mail/reply-assist/'
	const getCreditsApiURL = 'https://console.gofloww.co/api/mail/get-email-credits/'

	// Show the modal when the Auto-Draft button is clicked
	function showModal() {
		const modal = new bootstrap.Modal(document.getElementById('modal'));
		modal.show();
	}
	// to check if reply
	function checkReply(){
		// Temporary fix for identities bug
		document.querySelector("a[href='#identities']").remove();
		const emailSubject= document.getElementById('compose-subject').value;
		const replyAssistButton = document.getElementById('reply-assist-btn');
		const toolbar = document.getElementsByClassName('editor-toolbar')[0];
		var composePriority = document.getElementById('compose-priority');
		var composeStoreTarget = document.getElementById('compose-store-target');

		// Remove the 'custom-select' class if it exists
		if (composePriority && composePriority.classList.contains('custom-select')) {
			composePriority.classList.remove('custom-select');
		}

		if (composeStoreTarget && composeStoreTarget.classList.contains('custom-select')) {
			composeStoreTarget.classList.remove('custom-select');
		}

		// Removing the open in new window text
		var formButtonsDiv = document.querySelector('.formbuttons');
		if (formButtonsDiv) {
			var openInNewWindowButton = formButtonsDiv.querySelector('.float-right .button.icon');
			if (openInNewWindowButton) {
				openInNewWindowButton.textContent = '';
			}
		}

		var OpenInNewWindowButton = document.getElementsByClassName('extwin')[0];
		OpenInNewWindowButton.setAttribute("title", "Open in New Window");
		
		if (emailSubject.includes('Re:')) {
			let AiDraftButton = document.getElementById('auto-draft-button');
			let AiDraftText = document.getElementById('ai-draft-text');
			AiDraftText.textContent = ' Reply Assist ';
			AiDraftButton.setAttribute('data-target', '#reply-assist-modal');
		}
	}
	// Search functionality for phrases
	function searchPhrases() {
		const searchBar = document.getElementById('search-bar');
		const suggestionsList = document.getElementById('suggestions');
		const query = searchBar.value.toLowerCase();
		suggestionsList.innerHTML = '';

		if (query) {
			const matchedPhrases = phrases
				.filter(phrase => phrase.toLowerCase().includes(query))
				.slice(0, 5); // Limit to top 5 matches

			matchedPhrases.forEach(phrase => {
				const listItem = document.createElement('li');
				listItem.classList.add('list-group-item');
				listItem.classList.add('selected');
				listItem.textContent = phrase;
				suggestionsList.appendChild(listItem);

				listItem.addEventListener('click', function() {
					searchBar.value = listItem.textContent;
					suggestionsList.innerHTML = ''; // Clear suggestions after selection
				});
			});
		}
	}
	function convertToHtml(inputText) {
		if (/<[a-z][\s\S]*>/i.test(inputText)) {
			return inputText;
		}
		let paragraphs = inputText.split(/\n\n/);
		let htmlContent = paragraphs.map(paragraph => {
			let sanitized = paragraph.replace(/\n/g, '<br>');
			return `<p>${sanitized}</p>`;
		});
		return htmlContent.join('');
	}

	// Function to call OpenAI API to generate an email
	async function generateEmail() {
		//const searchBar = document.getElementById('search-bar');
		const emailDetails = document.getElementById('email-details');
		const selectedText = document.getElementById('composebody');
		const existingText = selectedText.value;
		const htmlText = document.getElementById('composebody_ifr');
		
		//const topic = searchBar.value;
		const description = emailDetails.value;
		const fromSelect = document.getElementById('_from');
		const from_email = fromSelect.options[fromSelect.selectedIndex].text;
		const SubjectSelect = document.getElementById('compose-subject');
		//console.log(topic);
		//console.log(description);
		var messageKey = rcmail.display_message('Generating email,please wait.....', 'loading');

		try {
			fetch(`${baseURL}auto-draft/`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({
					topic: description,
					description: '',
					from_email: from_email,
				}, 40000)
			}).then(response => {
				if (!response.ok) {
					return response.json().then(errorData => {
						const errorMessage = errorData.error || 'An unknown error occurred';
						throw new Error(errorMessage);  
					});
					//selectedText.value = `Error generating email. Please try again.\n\n${existingText}`;
					
				}
				return response.json();
			}).then(responseData => {

				const generatedEmail = responseData.email_body;
				const generatedSubject = responseData.subject;

				if(selectedText){
					selectedText.value = `${generatedEmail}\n\n${existingText}`;
				}
				if(htmlText){
					var iframeDoc = htmlText.contentDocument;
					var newParagraph = iframeDoc.createElement('div');
					newParagraph.innerHTML = convertToHtml(generatedEmail);
					var iframeBody = iframeDoc.body;
					iframeBody.insertBefore(newParagraph, iframeBody.firstChild);
				}
				
				SubjectSelect.value = generatedSubject;
				rcmail.hide_message(messageKey, false);
				displayCredits();
			}).catch(error => {
				//console.error('Error generating email:', error);
				showErrorModal('error-modal', 'Error', error.message);
				selectedText.value = `Error generating email. Please try again.\n\n${existingText}`;
				rcmail.hide_message(messageKey, false);
			})

		} catch (error) {
			//console.error('Error generating email:', error);
			showErrorModal('error-modal', 'Error', error.message);
			selectedText.value = `Error generating email. Please try again.\n\n${existingText}`;
			rcmail.hide_message(messageKey, false);
		}
		
	}

	function scheduleMessage(data){
		return fetch(`${baseURL}schedule-send/`, {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
			},
			body: JSON.stringify(data),
		}, 40000).then((response) => {
			if(!response.ok){
				//console.error('Error generating email:', error);
				throw new Error('Network response was not ok');
			}
			return response.json();
		}).then((result) =>{
			return result;
		}).catch((error)=>{
			//console.error('Error Scheduling email:', error);
		})
	}

	function formatDate(date) {
        const options = { day: 'numeric', month: 'short' };
        return date.toLocaleDateString('en-GB', options);
    }

    function formatTime(date) {
        const options = { hour: '2-digit', minute: '2-digit' };
        return date.toLocaleTimeString('en-GB', options);
    }

    function generateScheduleOptions() {
		const now = new Date();
	
		// Calculate Tomorrow Morning at 08:00 AM
		let tomorrowMorning = new Date(now);
		tomorrowMorning.setDate(now.getDate() + 1);
		tomorrowMorning.setHours(8, 0, 0, 0);
	
		// Calculate This Afternoon at 01:00 PM
		let thisAfternoon = new Date(now);
		thisAfternoon.setHours(13, 0, 0, 0);
	
		// If the current time is past today's afternoon, set thisAfternoon to tomorrow afternoon
		if (now.getHours() >= 13) {
			thisAfternoon = new Date(now);
			thisAfternoon.setDate(now.getDate() + 1);
			thisAfternoon.setHours(13, 0, 0, 0);
		}
	
		// Calculate Next Monday Morning at 08:00 AM
		let nextMondayMorning = new Date(now);
		const dayOfWeek = nextMondayMorning.getDay();
		const daysUntilMonday = (dayOfWeek === 0) ? 1 : (8 - dayOfWeek);
		nextMondayMorning.setDate(now.getDate() + daysUntilMonday);
		nextMondayMorning.setHours(8, 0, 0, 0);
	
		// If the current day is Monday and time has passed 08:00 AM, set nextMondayMorning to the next Monday
		if (dayOfWeek === 1 && now.getHours() >= 8) {
			nextMondayMorning.setDate(now.getDate() + 7);
		}

		const scheduleOptionsArray = [
		{
			id: 'option1',
			label: 'Tomorrow morning',
			date: tomorrowMorning,
			numericDate: formatDateNumeric(tomorrowMorning),
			numericTime: formatTimeNumeric(tomorrowMorning),
			formattedDate: formatDate(tomorrowMorning),
			formattedTime: formatTime(tomorrowMorning)
		},
		{
			id: 'option2',
			label: now.getHours() >= 13 ? 'Tomorrow afternoon' : 'This afternoon',
			date: thisAfternoon,
			numericDate: formatDateNumeric(thisAfternoon),
			numericTime: formatTimeNumeric(thisAfternoon),
			formattedDate: formatDate(thisAfternoon),
			formattedTime: formatTime(thisAfternoon)
		},
		{
			id: 'option3',
			label: 'Monday morning',
			date: nextMondayMorning,
			numericDate: formatDateNumeric(nextMondayMorning),
			numericTime: formatTimeNumeric(nextMondayMorning),
			formattedDate: formatDate(nextMondayMorning),
			formattedTime: formatTime(nextMondayMorning)
		}
		];

		// Sort the array by the date property
		scheduleOptionsArray.sort((a, b) => a.date - b.date);

		// Render the sorted schedule options into the modal
		scheduleOptions.innerHTML = scheduleOptionsArray.map(option => `
			<div class="schedule-option" id="${option.id}" onclick="selectOption('${option.id}', '${option.numericDate}', '${option.numericTime}')">
				<span>${option.label}</span>
				<span class="float-end">${option.formattedDate}, ${option.formattedTime}</span>
			</div>
		`).join('');
	
		// Insert the options into the modal
		//const scheduleOptions = document.getElementById('scheduleOptions');
		//scheduleOptions.innerHTML = `
		//	<div class="schedule-option active" id="option1" onclick="selectOption('option1', '${formatDateNumeric(tomorrowMorning)}', '${formatTimeNumeric(tomorrowMorning)}')">
		//		<span>Tomorrow morning</span>
		//		<span class="float-end">${formatDate(tomorrowMorning)}, ${formatTime(tomorrowMorning)}</span>
		//	</div>
		//	<div class="schedule-option" id="option2" onclick="selectOption('option2', '${formatDateNumeric(thisAfternoon)}', '${formatTimeNumeric(thisAfternoon)}')">
		//		<span>${now.getHours() >= 13 ? 'Tomorrow afternoon' : 'This afternoon'}</span>
		//		<span class="float-end">${formatDate(thisAfternoon)}, ${formatTime(thisAfternoon)}</span>
		//	</div>
		//	<div class="schedule-option" id="option3" onclick="selectOption('option3', '${formatDateNumeric(nextMondayMorning)}', '${formatTimeNumeric(nextMondayMorning)}')">
		//		<span>Monday morning</span>
		//		<span class="float-end">${formatDate(nextMondayMorning)}, ${formatTime(nextMondayMorning)}</span>
		//	</div>
		//`;
	}
	
	// Function to format the date into a readable format
	function formatDate(date) {
		return date.toLocaleDateString(undefined, {
			year: 'numeric',
			month: 'long',
			day: 'numeric'
		});
	}
	
	// Function to format the time into a readable format
	function formatTime(date) {
		return date.toLocaleTimeString(undefined, {
			hour: '2-digit',
			minute: '2-digit',
			hour12: true
		});
	}

	function formatDateNumeric(date){
		const year = date.getFullYear();
		const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are zero-based
		const day = String(date.getDate()).padStart(2, '0');
		return `${year}-${month}-${day}`;
	}

	function formatTimeNumeric(date){
		const hours = String(date.getHours()).padStart(2, '0');
		const minutes = String(date.getMinutes()).padStart(2, '0');
		return `${hours}:${minutes}`;
	}

	function extractEmailsFromComposeCC(composeId) {
		const composeCCDiv = document.querySelector(composeId);
		if (!composeCCDiv) return [];
		const recipients = composeCCDiv.querySelectorAll('.recipient-input .recipient');
		const emailList = [];
		recipients.forEach(recipient => {
			const nameSpan = recipient.querySelector('.name');
			const emailSpan = recipient.querySelector('.email');
			const name = nameSpan ? nameSpan.textContent.trim() : '';
			const email = emailSpan ? emailSpan.textContent.trim() : '';
			if (name && email) {
				emailList.push(`${name} ${email}`);
			} else if (!name && email) {
				emailList.push(email);
			}
		});
	
		if (emailList.length === 0) return "";
		return emailList.join(', ').replace(/,,+/g, ',').replace(/,\s*$/, '').trim();
	}
	
	async function selectOption(optionId, date, time) {
		const toEmail= document.getElementById('_to');
		const subject = document.getElementById('compose-subject');

		if (!toEmail || !subject) {
			console.error("Required elements (_to or compose-subject) are not found in the DOM.");
			return;
		}
		else if (!toEmail.value.trim() && !subject.value.trim()){
			showErrorModal('error-modal', 'Error', "'To' email field is empty, 'Subject' email field is empty");
			return;
		}
		else if (!toEmail.value.trim()) {
			showErrorModal('error-modal', 'Error', "'To' email field is empty");
			return;
		}
		else if (!subject.value.trim()) {
			showErrorModal('error-modal', 'Error', "'Subject' email field is empty");
			return;
		}
		else{
			// Deselect all options
			const options = document.getElementById('scheduleOptions').children;
			for (let i = 0; i < options.length; i++) {
				options[i].classList.remove('active');
			}
		
			// Select the clicked option by its ID
			const selectedOption = document.getElementById(optionId);
			if (selectedOption) {
				selectedOption.classList.add('active');
			}

			const subjectValue = document.getElementById('compose-subject').value;
			const fromSelect = document.getElementById('_from');
			const fromText = fromSelect.options[fromSelect.selectedIndex].text;
			const newSubject = `<Scheduled email: ${date} ${time}>${subjectValue}`
			document.getElementById('compose-subject').value = newSubject;
			const cc = extractEmailsFromComposeCC("#compose_cc");
			const bcc = extractEmailsFromComposeCC("#compose_bcc");
			const data = {
				from: fromText,
				subject: newSubject ,
				cc: cc,
				bcc: bcc,
				date: date,
				time: time
			}
			//console.log(data);
			await rcmail.command('savedraft','',this,event)
			scheduleMessage(data)
				.then((result) => {
					//console.log("Message Scheduled Successfully:", result);
					if(result.message === "message scheduled successfully"){
						window.location.href = "/?_task=mail&_mbox=Scheduled";
					}
					//rcmail.command('savedraft','',this,event)
					//change in production
				})
				.catch((error) =>{
					//console.error("Error scheduling message:", error);
				});
			//console.log(data);
		}
	}
		
    // Update the selected date and time on the page
    function updateSelectedDateTime(dateString) {
        const date = new Date(dateString);
        const formattedDateTime = `${formatDate(date)}, ${formatTime(date)}`;
        document.getElementById('selectedDateTime').innerText = `Selected Date & Time: ${formattedDateTime}`;
    }

    // Generate options when the modal is shown
    document.getElementById('scheduleSendModal').addEventListener('shown.bs.modal', generateScheduleOptions);

    // Handle custom schedule button click
	function handleCustomScheduleClick() {
		const toEmail= document.getElementById('_to');
		const subject = document.getElementById('compose-subject');

		if (!toEmail || !subject) {
			console.error("Required elements (_to or compose-subject) are not found in the DOM.");
			return;
		}
		else if (!toEmail.value.trim() && !subject.value.trim()){
			showErrorModal('error-modal', 'Error', "'To' email field is empty, 'Subject' email field is empty");
			return;
		}
		else if (!toEmail.value.trim()) {
			showErrorModal('error-modal', 'Error', "'To' email field is empty");
			return;
		}
		else if (!subject.value.trim()) {
			showErrorModal('error-modal', 'Error', "'Subject' email field is empty");
			return;
		}
		else{
			const selectedDate = document.getElementById('scheduleDate').value;
			const selectedTime = document.getElementById('scheduleTime').value;

			const subjectValue = document.getElementById('compose-subject').value;
			const fromSelect = document.getElementById('_from');
			const fromText = fromSelect.options[fromSelect.selectedIndex].text;
			const newSubject = `<Scheduled email: ${selectedDate} ${selectedTime}>${subjectValue}`
			document.getElementById('compose-subject').value = newSubject;
			const cc = extractEmailsFromComposeCC("#compose_cc");
			const bcc = extractEmailsFromComposeCC("#compose_bcc");
			const data = {
				from: fromText,
				subject: newSubject ,
				cc: cc,
				bcc: bcc,
				date: selectedDate,
				time: selectedTime
			}
			//console.log(data);
			rcmail.command('savedraft','',this,event)
			scheduleMessage(data)
				.then((result) => {
					//console.log("Message Scheduled Successfully:", result);
					if(result.message === "message scheduled successfully"){
						window.location.href = "/?_task=mail&_mbox=Scheduled";
					}
					//rcmail.command('savedraft','',this,event)
					//change in production
				})
				.catch((error) =>{
					//console.error("Error scheduling message:", error);
				});
			//console.log(data);

			// Close the custom date-time picker modal
			var customDateTimeModal = new bootstrap.Modal(document.getElementById('custom-date-time-modal'));
			customDateTimeModal.hide();
		}
	}

	async function replyAssist() {
		const replyDetails = document.getElementById('reply-details');
		const emailSubject= document.getElementById('compose-subject');
		const selectedText = document.getElementById('composebody');
		const htmlText = document.getElementById('composebody_ifr');
		const existingText = selectedText.value;
		const fromSelect = document.getElementById('_from');
		const from_email = fromSelect.options[fromSelect.selectedIndex].text;
		const context = replyDetails.value; 
		//console.log({subject: emailSubject.value, email_body: existingText});
		var messageKey = rcmail.display_message('Generating reply,please wait.....', 'loading');
		try {
			fetch(`${baseURL}reply-assist/`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({
					subject: emailSubject.value,
					email_body: existingText,
					from_email: from_email,
					context: context
				},40000)
			}).then(response =>{
				if(!response.ok){
					return response.json().then(errorData => {
						const errorMessage = errorData.error || 'An unknown error occurred';
						throw new Error(errorMessage);  
					});
					
				}
				return response.json();
			}).then(responseData =>{
				const generatedEmail = responseData.email_body;
				if(selectedText){
					selectedText.value = `${generatedEmail}\n\n${existingText}`;
				}
				if(htmlText){
					var iframeDoc = htmlText.contentDocument;
					var newParagraph = iframeDoc.createElement('div');
					newParagraph.innerHTML = convertToHtml(generatedEmail);
					var iframeBody = iframeDoc.body;
					iframeBody.insertBefore(newParagraph, iframeBody.firstChild);
				}
				rcmail.hide_message(messageKey, false);
				displayCredits();
			}).catch(error =>{
				//console.error('Error generating email:', error);
				showErrorModal('error-modal', 'Error', error.message);
				selectedText.value = `Error generating email. Please try again.\n\n${existingText}`;
				rcmail.hide_message(messageKey, false);
			})
		} catch (error) {
			//console.error('Error generating email:', error);
			showErrorModal('error-modal', 'Error', error.message);
			selectedText.value = `Error generating email. Please try again.\n\n${existingText}`;
			rcmail.hide_message(messageKey, false);
		}
		
	}

	function convertMobileView(){
		//detectViewAndDisplayCredits();
		var clonedAutoDraftButton = $('#auto-draft-button-clone');
		var clonedScheduleSendButton = $('#schedule-send-button-clone');
		var clonedtemplateButton = $('#templates-button-clone');

        if (clonedAutoDraftButton.length) {
            // Ensure it's a jQuery object
			const emailSubject= document.getElementById('compose-subject').value;
			
            clonedAutoDraftButton = $(clonedAutoDraftButton);

            // Remove the ::before pseudo-element by setting its 'content' to 'none'
            clonedAutoDraftButton[0].style.setProperty('content', 'none');

            // Remove 'disabled' class
            clonedAutoDraftButton.removeClass('disabled');

            // Clear any existing content and add the new icon and text
			if(emailSubject.includes('Re:')){
				clonedAutoDraftButton.html(`
                <span class="icon" style="display: inline-block; text-align: center;">
                    <i class="fa-solid fa-wand-magic-sparkles" aria-hidden="true" style="font-size: 20px; background: linear-gradient(90deg, #00ceb1 0%, #1E92FB 100%); -webkit-background-clip: text; color: transparent;"></i>
                    <br/>
                </span>
                <span style="display: block; text-align: center;" id="ai-draft-text">Reply Assist</span>
            	`);
			}else{
				clonedAutoDraftButton.html(`
                <span class="icon" style="display: inline-block; text-align: center;">
                    <i class="fa-solid fa-wand-magic-sparkles" aria-hidden="true" style="font-size: 20px; background: linear-gradient(90deg, #00ceb1 0%, #1E92FB 100%); -webkit-background-clip: text; color: transparent;"></i>
                    <br/>
                </span>
                <span style="display: block; text-align: center;" id="ai-draft-text">AI draft</span>
            	`);
			}
           

            // Add the onclick event to open the modal
			if(emailSubject.includes('Re:')){
				clonedAutoDraftButton.on('click', function(e) {
					e.preventDefault(); // Prevent default anchor behavior
					$('#reply-assist-modal').modal('show');
				});
			}else{
				clonedAutoDraftButton.on('click', function(e) {
					e.preventDefault(); // Prevent default anchor behavior
					$('#auto-draft-modal').modal('show');
				});
			}
            

            // Ensure tabindex and class adjustments
            clonedAutoDraftButton.attr('tabindex', '0')
                                .addClass('btn')
                                .removeClass('button');
        }
		

        if (clonedScheduleSendButton.length) {
            clonedScheduleSendButton = $(clonedScheduleSendButton);

            // Remove 'disabled' class
            clonedScheduleSendButton.removeClass('disabled');

            // Clear existing content and add new icon and text
            clonedScheduleSendButton.html(`
                <span class="icon" style="display: inline-block; text-align: center;">
                    <i class="fa-regular fa-clock" aria-hidden="true" style="font-size: 20px;"></i>
                    <br/>
                </span>
                <span style="display: block; text-align: center;">Schedule</span>
            `);

            // Add the onclick event to open the modal and execute the function
            clonedScheduleSendButton.on('click', function(e) {
                e.preventDefault();
                generateScheduleOptions(); // Call your existing function
                $('#schedule-send-modal').modal('show'); // Show the modal
            });

            // Ensure tabindex and class adjustments
            clonedScheduleSendButton.attr('tabindex', '0')
                                    .addClass('btn')
                                    .removeClass('button');
        }

		if (clonedtemplateButton.length) {
            clonedtemplateButton = $(clonedtemplateButton);

            // Remove 'disabled' class
            clonedtemplateButton.removeClass('disabled');

            // Clear existing content and add new icon and text
            clonedtemplateButton.html(`
                <span class="icon" style="display: inline-block; text-align: center;">
                    <i class="fa-solid fa-file" aria-hidden="true" style="font-size: 20px;"></i>
                    <br/>
                </span>
                <span style="display: block; text-align: center;">Templates</span>
            `);

            // Add the onclick event to open the modal and execute the function
            clonedtemplateButton.on('click', function(e) {
                e.preventDefault();
                getTemplates(); // Call your existing function
                $('#template-modal').modal('show'); // Show the modal
            });

            // Ensure tabindex and class adjustments
            clonedtemplateButton.attr('tabindex', '0')
                                    .addClass('btn')
                                    .removeClass('button');
        }

	}

	
	function showErrorModal(modalId, title, message) {
		// Set the modal title
		document.querySelector(`#${modalId} .modal-title`).textContent = title;
	
		// Set the modal message
		document.querySelector(`#${modalId} .modal-body`).textContent = message;
	
		// Show the modal using Bootstrap's modal function
		$(`#${modalId}`).modal('show');
	}

	function addTag() {
		const tagInput = document.getElementById('tag-input');
		const tagValue = tagInput.value.trim();
		if (tagValue !== '') {
			// Create a new list item for the tag
			const tagItem = document.createElement('li');
			tagItem.classList.add('d-inline-flex', 'align-items-center');
			tagItem.innerHTML = `
				<span class="badge badge-pill badge-info mr-2">${tagValue}</span>
				<button type="button" class="btn btn-sm btn-danger" onclick="removeTag(this)">X</button>
			`;
			document.getElementById('tags-list').appendChild(tagItem);
			tagInput.value = ''; // Clear the input field after adding
		}
	}
	
	function removeTag(button) {
		const tagItem = button.closest('li');
		tagItem.remove();
	}
	
	async function getTemplates(){
		const fromSelect = document.getElementById('_from');
		const from_email = fromSelect.options[fromSelect.selectedIndex].text;
		
		const response = await fetch(`${baseURL}get-template-list/`, {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify({ email: from_email}, 40000)
		});
		const responseData = await response.json();
		if(response.ok){
			templates = responseData.templates;
			const templateContainer = document.getElementById("template-list");
			const noTemplatesMessage = document.getElementById("no-templates");
			const filterTagList = document.getElementById("tag-filter-list");
			const filterTypeList = document.getElementById("type-filter-list");

			if (templateContainer) {
				const listItems = document.getElementsByClassName('templates');
				if(listItems){
					Array.from(listItems).forEach(listItem =>{
						listItem.remove();
					})
				}
			}

			filterTagList.innerHTML = "";

			const uniqueTags = new Set();
			uniqueTags.add("Show All");
			templates.forEach(template => {
				template.tags.forEach(tagObj => {
					uniqueTags.add(tagObj.tag);
				});
			});

			// Populate filter dropdown
			uniqueTags.forEach(tag => {
				const li = document.createElement("li");
				li.className = "tags-filter";
				li.textContent = tag;
				li.onclick = () => filterTemplatesByTag(tag, templates);
				filterTagList.appendChild(li);
			});

			filterTypeList.innerHTML = ""; // Clear existing content

			const typeOptions = ["Show All", "Organizational", "Private"]; 
			typeOptions.forEach(type => {
				const li = document.createElement("li");
				li.className = "type-filter";
				li.textContent = type;
				li.onclick = () => filterTemplatesByType(type, templates); 
				filterTypeList.appendChild(li);
			});

			if (noTemplatesMessage) noTemplatesMessage.style.display = "none";

			renderTemplateList(templates, templateContainer);
		}
	}

	function renderTemplateList(templates, container) {
		const ul = document.createElement("ul");
		ul.className = "templates";
	
		// Reverse templates and create list items
		templates.reverse().forEach(template => {
			const li = document.createElement("li");
			li.className = "list-group-item template-item";
			li.style.cursor = "pointer";
			li.setAttribute("data-toggle", "modal");
			li.setAttribute("data-target", "#template-modal");
			
			// Handle click event on list item
			li.onclick = function () {
				getTemplate(template.template_id);
			};
	
			// Text content for the template name
			const span = document.createElement("span");
			span.textContent = template.template_name;
	
			// Create the 'a' tag for delete
			const deleteLink = document.createElement("span");
			deleteLink.className = "temp-del icons";
			deleteLink.style.cursor = "pointer";
			deleteLink.style.marginLeft = "auto"; // Align to the right when using flexbox
			deleteLink.setAttribute("data-dismiss", "modal");
			deleteLink.setAttribute("data-toggle", "modal");
			deleteLink.setAttribute("data-target", "#delete-confirm-modal");
			const trashIcon = document.createElement("i");
			trashIcon.className = "fa-solid fa-trash";
	
			// Add event handler for delete
			deleteLink.onclick = function (event) {
				event.stopPropagation(); // Prevent triggering the li click
				deleteTemplate(template.template_id);
			};
	
			// Style the list item for proper layout
			li.style.display = "flex";
			li.style.justifyContent = "space-between"; // Distribute content with space between
			li.style.alignItems = "center"; // Center-align vertically
	
			// Append elements
			deleteLink.appendChild(trashIcon);
			li.appendChild(span); // Add the template name
			li.appendChild(deleteLink); // Add the delete link
			ul.appendChild(li); // Add the list item to the list
		});
	
		// Append the list to the container
		container.appendChild(ul);
	}
	
	
	function filterTemplatesByTag(tag, templates) {
		const templateContainer = document.getElementById("template-list");
		let filteredTemplates;

		const dropdownButton = document.getElementsByClassName("tag-dropdown")[0];
		dropdownButton.textContent = tag;

		if (tag === "Show All") {
			// Show all templates
			filteredTemplates = templates;
		} else {
			// Filter templates by the selected tag
			filteredTemplates = templates.filter(template =>
				template.tags.some(tagObj => tagObj.tag === tag)
			);
		}
	
		// Clear current templates
		const listItems = document.getElementsByClassName('templates');
		if (listItems) {
			Array.from(listItems).forEach(listItem => {
				listItem.remove();
			});
		}
	
		// Render filtered templates
		renderTemplateList(filteredTemplates, templateContainer);
	
		// Show "No Templates" if no match
		const noTemplatesMessage = document.getElementById("no-templates");
		if (filteredTemplates.length === 0 && noTemplatesMessage) {
			noTemplatesMessage.style.display = "block";
		} else if (noTemplatesMessage) {
			noTemplatesMessage.style.display = "none";
		}
	}

	function filterTemplatesByType(type, templates) {
		const templateContainer = document.getElementById("template-list");

		const dropdownButton = document.getElementsByClassName("type-dropdown")[0];
		dropdownButton.textContent = type;

		// Filter templates based on type
		const filteredTemplates = type === "Show All"
			? templates
			: templates.filter((template) => template.organizational === (type === "Organizational"));

		// Clear existing templates
		const listItems = document.querySelectorAll('.templates');
		listItems.forEach((listItem) => listItem.remove());

		// Render filtered templates
		renderTemplateList(filteredTemplates, templateContainer);

		// Show "No Templates" if no match
		const noTemplatesMessage = document.getElementById("no-templates");
		if (filteredTemplates.length === 0 && noTemplatesMessage) {
			noTemplatesMessage.style.display = "block";
		} else if (noTemplatesMessage) {
			noTemplatesMessage.style.display = "none";
		}

	}

	function isValidHtmlString(str) {
		var doc = new DOMParser().parseFromString(str, "text/html");
		return Array.from(doc.body.childNodes).some((node) => node.nodeType === 1); // Check for any element nodes
	}

	async function getTemplate(template_id){
		var messageKey = rcmail.display_message('Loading template,please wait.....', 'loading');
		try{
			const fromSelect = document.getElementById('_from');
			const from_email = fromSelect.options[fromSelect.selectedIndex].text;
			const response = await fetch(`${baseURL}get-template/`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({ email:from_email, template_id: template_id}, 40000)
			});
			const responseData = await response.json();

			if(response.ok){
				const selectedText = document.getElementById('composebody');
				const htmlText = document.getElementById('composebody_ifr');
				const existingText = selectedText.value;
				const templateContent = responseData.template.template_content;
				const subject = document.getElementById('compose-subject');
				if(selectedText){
					selectedText.value = `${templateContent}`;
				}	
				if(htmlText){
					const iframeDoc = htmlText.contentDocument;
					var newParagraph = iframeDoc.createElement('div');
					newParagraph.innerHTML = convertToHtml(templateContent);
					var iframeBody = iframeDoc.body;
					iframeBody.innerHTML = '';
					iframeBody.appendChild(newParagraph);
				}
				subject.value = responseData.template.template_subject;
				rcmail.hide_message(messageKey, false);
			}else{
				showErrorModal('error-modal', 'Error', responseData.error);
				rcmail.hide_message(messageKey, false);
			}	
		}catch(e) {
			//console.log('Error: ',e);
			showErrorModal('error-modal', 'Error', 'Error fetching template try again later..');
			rcmail.hide_message(messageKey, false);
		}
		
	}

	async function saveTemplate(){
		var messageKey = rcmail.display_message('Adding template ,please wait.....', 'uploading');
		try{
			const fromSelect = document.getElementById('_from');
			const from_email = fromSelect.options[fromSelect.selectedIndex].text;
			const selectedText = document.getElementById('composebody');
			const htmlText = document.getElementById('composebody_ifr');
			const subject = document.getElementById('compose-subject');
			var subjectValue = subject.value;
			//if(!subjectValue){
			//	subjectValue = subject.innerText;
			//}
			var template_content;
			if(selectedText){
				template_content = selectedText.value;
			}
			if(htmlText){
				var iframeDoc = htmlText.contentDocument;
				var templateContent = JSON.stringify(iframeDoc.body.innerHTML);
			}
			 
			const templateName = document.getElementById('template-name')
			const template_name = templateName.value;
			const scope = document.querySelector('input[name="template-scope"]:checked')?.value;
			const organizational = scope === 'organizational';
			const tags = [];
			document.querySelectorAll('#tags-list .badge').forEach(tag => {
				tags.push(tag.innerText.trim());
			});
			console.log({email:from_email, template_name: template_name, template_subject: subjectValue, template_content: template_content, organizational: organizational, tags: tags})
			
			const response = await fetch(`${baseURL}add-template/`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({ email:from_email, template_name: template_name, template_subject: subjectValue, template_content: template_content, organizational: organizational, tags: tags}, 40000)
			});
			const responseData = await response.json();
			if(response.ok){
				rcmail.hide_message(messageKey, false);
				rcmail.display_message('Template added successfully', 'confirmation');
				
			}else{
				rcmail.hide_message(messageKey, false);
				if(responseData.error=="Template limit exceeded"){
					$('#template-limit-modal').modal('show');
				}else{
					messageKey = rcmail.display_message('Could not add the template', 'warning');
				}
			}
		}catch(e) {
			//console.log('Error: ',e);
			rcmail.hide_message(messageKey, false);
			rcmail.display_message('Could not add the template', 'warning');
			
		}
	}

	var selectedTemplateId = null;
	function openDeleteModal(template_id) {
		selectedTemplateId = template_id; // Store the template ID
		//const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
		//deleteModal.show();
	}

	async function deleteTemplate(template_id){
		var messageKey = rcmail.display_message('Deleting template ,please wait.....', 'uploading');
		try{
			const fromSelect = document.getElementById('_from');
			const from_email = fromSelect.options[fromSelect.selectedIndex].text;
			const response = await fetch(`${baseURL}delete-template/`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({ email:from_email, template_id:template_id}, 40000)
			});
			const responseData = await response.json();
			if(response.ok){
				rcmail.hide_message(messageKey, false);
				rcmail.display_message('Template deleted successfully', 'confirmation');
				
			}else{
				rcmail.hide_message(messageKey, false);
				messageKey = rcmail.display_message('Could not delete the template', 'warning');
				
			}
		}catch(e) {
			//console.log('Error: ',e);
			rcmail.hide_message(messageKey, false);
			rcmail.display_message('Could not delete the template', 'warning');
			
		}
		template_id= null;
	}

	async function getTemplatesToDelete(){
		const fromSelect = document.getElementById('_from');
		const from_email = fromSelect.options[fromSelect.selectedIndex].text;
		
		const response = await fetch(`${baseURL}get-template-to-delete/`, {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify({ email: from_email}, 40000)
		});
		const responseData = await response.json();
		if(response.ok){
			templates = responseData.templates;
			const templateContainer = document.getElementById("delete-template-list");
			const noTemplatesMessage = document.getElementById("no-templates-delete");

			if (templateContainer) {
				const listItems = document.getElementsByClassName('templates');
				if(listItems){
					Array.from(listItems).forEach(listItem =>{
						listItem.remove();
					})
				}
			}
			if (noTemplatesMessage) noTemplatesMessage.style.display = "none";
			//console.log(templates)
			const ul = document.createElement("ul");
			ul.className = "templates";
			templates.reverse().forEach(template => {
				const li = document.createElement("li");
				li.className = "list-group-item template-item";
				li.textContent = template.template_name;
				li.cursor = 'pointer';
				li.setAttribute("data-toggle", "modal");
				li.setAttribute("data-target", "#delete-template-modal");
				li.onclick = function(){
					deleteTemplate(template.template_id)
				}
				
				ul.appendChild(li);
			})
			templateContainer.appendChild(ul);
		}
	}

</script>

<roundcube:include file="includes/footer.html" />
