<roundcube:if condition="!env:framed || env:extwin" />
</div>
<roundcube:if condition="config:support_url" />
<a href="<roundcube:var name='config:support_url' />" target="_blank" id="supportlink" class="hidden"><roundcube:label name="support" /></a>
<roundcube:endif />
<roundcube:endif />

<roundcube:object name="message" id="messagestack" />


<script>
	function checksubject(){
		// Start monitoring URL changes
		monitorURLChanges();
		
		// Initial call to inject button on page load
		injectEditButton();
	}
	function injectEditButton() {
		// Check if the URL contains _mbox=Scheduled
		const urlParams = new URLSearchParams(window.location.search);
		const mboxValue = urlParams.get('_mbox');
	
		// Inject only if _mbox=Scheduled
		if (mboxValue === 'Scheduled') {
			// Locate the rightcol div
			const rightCol = document.getElementsByClassName('rightcol')[0];
			const existingCancelButton = document.getElementById('cancel-send-btn');

			if (rightCol && !existingCancelButton) {  // Check if the element is not already injected
				// Create the message-objects container
				const messageObjects = document.createElement('div');
				messageObjects.id = 'message-objects';
	
				// Create the message-buttons div
				const messageButtons = document.createElement('div');
				messageButtons.id = 'message-buttons';
				messageButtons.className = 'information ui alert alert-info boxinformation';
	
				// Add icon and draft message
				const icon = document.createElement('i');
				icon.className = 'icon';
	
				const draftMessage = document.createElement('span');
				draftMessage.textContent = 'This is a Scheduled message.';
	
				// Non-breaking space
				const space = document.createTextNode('\u00A0');
	
				// Create the Edit button
				const editBtn = document.createElement('a');
				editBtn.href = '#';
				editBtn.onclick = function() { rcmail.command('delete','',this,event); rcmail.command('delete','',this,event); };
				editBtn.className = 'btn btn-primary btn-sm';
				editBtn.id = 'cancel-send-btn'
				editBtn.textContent = 'Cancel Send';
	
				// Append elements to message-buttons
				messageButtons.appendChild(icon);
				messageButtons.appendChild(draftMessage);
				messageButtons.appendChild(space);
				messageButtons.appendChild(editBtn);
	
				// Append message-buttons to message-objects
				messageObjects.appendChild(messageButtons);
	
				// Inject message-objects before messagebody in the rightcol
				const messageBody = document.getElementById('messagebody');
				if (messageBody) {
					rightCol.insertBefore(messageObjects, messageBody);
				}
			}
		}
	}
	
	// Function to detect URL changes using pushState or replaceState
	function monitorURLChanges() {
		const originalPushState = history.pushState;
		const originalReplaceState = history.replaceState;
	
		// Override history.pushState to detect changes
		history.pushState = function() {
			originalPushState.apply(this, arguments);
			injectEditButton();  // Call function after pushState
		};
	
		// Override history.replaceState to detect changes
		history.replaceState = function() {
			originalReplaceState.apply(this, arguments);
			injectEditButton();  // Call function after replaceState
		};
	
		// Also detect back/forward navigation (popstate)
		window.addEventListener('popstate', function() {
			injectEditButton();  // Call function after popstate event
		});
	}

	function injectTranslateLink() {
		// Select the 'header-links' element inside the specific structure
		const frame = document.querySelector('#layout-content .iframe-wrapper #messagecontframe');
		const headerLinks = frame.contentDocument.getElementsByClassName('header-links')[0];
		
		if (headerLinks) {
			// Create a new <a> element
			const translateLink = document.createElement('a');
			
			
			translateLink.href = "#translate";
			translateLink.textContent = "Translate to English";
			translateLink.onclick = function() {
				translateEmail();
				return false; // Prevent default anchor behavior
			};
			
			
			translateLink.style.backgroundImage = 'linear-gradient(90deg, #00ceb1 0%, #1E92FB 100%)';
			translateLink.style.webkitBackgroundClip = 'text';  // For Webkit browsers (Chrome, Safari)
			translateLink.style.backgroundClip = 'text';        // Standard property
			translateLink.style.color = 'transparent';          // Makes the text color transparent
			
			
			translateLink.style.marginLeft = '10px'; 
			
			
			headerLinks.appendChild(translateLink);
	
			console.log("Translate link added successfully.");
		} else {
			console.log("Element with the specific 'header-links' selector not found.");
		}
	}

	function translateEmail() {
		const frame = document.querySelector('#layout-content .iframe-wrapper #messagecontframe');
		const messageBody = frame.contentDocument.getElementById('messagebody');
		const content = messageBody.getElementsByClassName('pre')[0];
		const emailBody = content.innerHTML;

		if(content){
			const emailBody = content.innerHTML;
			console.log(email_body);
			//try {
			//	fetch(translateApiURL, {
			//		method: 'POST',
			//		headers: {
			//			'Content-Type': 'application/json'
			//		},
			//		body: JSON.stringify({
			//			email_body: content,
			//			from_email: from_email
			//		},40000)
			//	}).then(response =>{
			//		if(!response.ok){
			//			return response.json().then(errorData => {
			//				const errorMessage = errorData.error || 'An unknown error occurred';
			//				throw new Error(errorMessage);  
			//			});
			//		}
			//		return response.json();
			//	}).then(responseData =>{
			//	}).then(responseData =>{
			//		const generatedEmail = responseData.email_body;
			//		preElement.innerHTML = `${generatedEmail}\n\n${existingText}`;
			//	}).catch(error =>{
			//		console.error('Error translating email:', error);
			//		showErrorModal('error-modal', 'Error', error.message);
			//		
			//	})
			//} catch (error) {
			//	console.error('Error translating email:', error);
			//	showErrorModal('error-modal', 'Error', error.message);
			//	
			//}
		}

		
	}

	document.addEventListener('DOMContentLoaded', function() {
		// Check if the target div is present
		const targetDiv = document.querySelector('.content.frame-content');
		if (targetDiv) {
		injectTranslateLink();
		}
	});
</script>


<script src="/deps/bootstrap.bundle.min.js"></script>
<script src="/ui.js"></script>

</body>
</html>
