/**
 * Roundcube webmail functions for the Elastic skin
 *
 * Copyright (c) The Roundcube Dev Team
 *
 * The contents are subject to the Creative Commons Attribution-ShareAlike
 * License. It is allowed to copy, distribute, transmit and to adapt the work
 * by keeping credits to the original autors in the README file.
 * See http://creativecommons.org/licenses/by-sa/3.0/ for details.
 *
 * @license magnet:?xt=urn:btih:90dc5c0be029de84e523b9b3922520e79e0e6f08&dn=cc0.txt CC0-1.0
 */
"use strict";function rcube_elastic_ui(){var prefs,ref=this,mode="normal",color_mode="light",touch=false,ios=false,popups_close_lock,is_framed=rcmail.is_framed(),env={config:{standard_windows:rcmail.env.standard_windows,message_extwin:rcmail.env.message_extwin,compose_extwin:rcmail.env.compose_extwin,help_open_extwin:rcmail.env.help_open_extwin},checkboxes:0,small_screen_config:{standard_windows:true,message_extwin:false,compose_extwin:false,help_open_extwin:false}},menus={},content_buttons=[],frame_buttons=[],layout={menu:$("#layout-menu"),sidebar:$("#layout-sidebar"),list:$("#layout-list"),content:$("#layout-content")},buttons={menu:$("a.task-menu-button"),back_sidebar:$("a.back-sidebar-button"),back_list:$("a.back-list-button"),back_content:$("a.back-content-button")};this.register_content_buttons=register_content_buttons;this.menu_hide=menu_hide;this.menu_toggle=menu_toggle;this.menu_destroy=menu_destroy;this.popup_init=popup_init;this.about_dialog=about_dialog;this.headers_dialog=headers_dialog;this.import_dialog=import_dialog;this.props_dialog=props_dialog;this.headers_show=headers_show;this.spellmenu=spellmenu;this.searchmenu=searchmenu;this.headersmenu=headersmenu;this.header_reset=header_reset;this.compose_status=compose_status;this.attachmentmenu=attachmentmenu;this.mailtomenu=mailtomenu;this.recipient_selector=recipient_selector;this.show_list=show_list;this.show_sidebar=show_sidebar;this.smart_field_init=smart_field_init;this.smart_field_reset=smart_field_reset;this.form_errors=form_errors;this.switch_nav_list=switch_nav_list;this.searchbar_init=searchbar_init;this.pretty_checkbox=pretty_checkbox;this.pretty_select=pretty_select;this.datepicker_init=datepicker_init;this.bootstrap_style=bootstrap_style;this.toggle_list_selection=toggle_list_selection;this.get_screen_mode=get_screen_mode;this.is_mobile=is_mobile;this.is_touch=is_touch;screen_mode();layout_init();bootstrap_style();toolbar_init();content_frame_init();dropdowns_init();setup();resize();function setup(){var title,form,content_buttons=[];$.ui&&$.widget("ui.dialog",$.ui.dialog,{open:function(){if($(this.element).is(".iframe")){this.options.width=Math.max(576,this.options.width)}this._super();dialog_open(this);return this},close:function(){this._super();$(".select-menu:visible").remove();return this}});buttons.menu.on("click",(function(){app_menu(true);return false}));buttons.back_sidebar.on("click",(function(){show_sidebar();return false}));buttons.back_list.on("click",(function(){show_list();return false}));buttons.back_content.on("click",(function(){show_content(true);return false}));$(".searchbar").each((function(){searchbar_init(this)}));if(is_framed&&!rcmail.env.extwin&&!parent.$(".ui-dialog:visible").length){if(title=$("h1.voice").first().text()){parent.$("#layout-content > .header > .header-title:not(.constant)").text(title)}}else if(!is_framed){title=layout.content.find(".boxtitle").first().detach().text();if(!title){title=$("h1.voice").first().text()}if(title){layout.content.find(".header > .header-title").text(title)}}if(!is_framed&&layout.content.length&&!layout.content.is(".no-navbar")&&!layout.content.children(".frame-content").length){env.frame_nav=$('<div class="footer menu toolbar content-frame-navigation hide-nav-buttons">').append($('<a class="button prev">').append($('<span class="inner"></span>').text(rcmail.gettext("previous")))).append($('<span class="buttons">')).append($('<a class="button next">').append($('<span class="inner"></span>').text(rcmail.gettext("next")))).appendTo(layout.content)}$("a[data-content-button]").each((function(){content_buttons.push(create_cloned_button($(this)))}));$(".formbuttons").filter((function(){return!$(this).parent(".searchoptions").length})).find("button").each((function(){var target=$(this);if(!is_framed&&!target.parents("#layout-content").length){return}if(target.is(".cancel")){target.addClass("hidden");return}content_buttons.push(create_cloned_button(target))}));(is_framed?parent.UI:ref).register_content_buttons(content_buttons);if(form=rcmail.gui_objects.messageform){form=$('form[name="'+form+'"]');$("#_cc, #_bcc, #_replyto, #_followupto",$(".compose-headers")).each((function(){$(this).on("change",(function(){$("#compose"+$(this).attr("id"))[this.value?"removeClass":"addClass"]("hidden")}))}));$("#compose-options").find("textarea,input,select").each((function(){var hidden=$("<input>").attr({type:"hidden",name:$(this).attr("name")}).appendTo(form);$(this).attr("tabindex",2).on("change",(function(){hidden.val(this.type!="checkbox"||this.checked?$(this).val():"")})).change()}))}$("[data-recipient-input]").each((function(){recipient_input(this)}));$(".image-upload").each((function(){image_upload_input(this)}));$("textarea[data-html-editor]").each((function(){html_editor_init(this)}));$("#dragmessage-menu,#dragcontact-menu").each((function(){rcmail.gui_object("dragmenu",this.id)}));$("#taskmenu > a").each((function(){if(/button-([a-z]+)/.test(this.className)){var data,name=RegExp.$1,button=find_button(this.id);if(button&&(data=button.data)){if(data.sel){data.sel=data.sel.replace("button-selected","selected")+" "+name}if(data.act){data.act+=" "+name}rcmail.buttons[button.command][button.index]=data;rcmail.init_button(button.command,data)}$(this).addClass(name);$(".button-inner",this).addClass("inner")}$(this).on("mouseover",(function(){rcube_webmail.long_subject_title(this,0,$("span.inner",this))}))}));$(".listbutton").each((function(){var button=find_button(this.id);$(this).addClass("button").removeClass("listbutton");if(button.data.sel){button.data.sel=button.data.sel.replace("listbutton","button")}if(button.data.act){button.data.act=button.data.act.replace("listbutton","button")}rcmail.buttons[button.command][button.index]=button.data;rcmail.init_button(button.command,button.data)}));$("[data-hidden]").each((function(){var m,v=$(this).data("hidden"),parent=$(this).parent("li"),re=/(large|big|small|phone|lbs)/g;while(m=re.exec(v)){$(parent.length?parent:this).addClass("hidden-"+m[1])}}));$("[data-list]").each((function(){$("input[type=checkbox]",this).each((function(){pretty_checkbox(this)}))}));if(is_framed){$(".formcontent").each((function(){if($(this).next(".formbuttons").length){$(this).parent().addClass("formcontainer")}}))}$("#attachment-list + a.zipdownload").appendTo(".header-links");if(ios=$("html").is(".ipad,.iphone")){$(".iframe-wrapper, .scroller").addClass("ios-scroll")}if($("html").filter(".ipad,.iphone,.webkit.mobile,.webkit.tablet").addClass("webkit-scroller").length){$(layout.menu).addClass("webkit-scroller")}$(".treelist").each((function(){var list=this,callback=function(){$(list)[$(".treetoggle",list).length>0?"removeClass":"addClass"]("notree")};if(window.MutationObserver){new MutationObserver(callback).observe(list,{childList:true,subtree:true})}callback();$("li.mailbox > a").on("mouseover",(function(){rcube_webmail.long_subject_title_ex(this)}))}))}function register_content_buttons(buttons){if(env.frame_nav&&buttons&&buttons.length){var toolbar=env.frame_nav.children(".buttons");content_buttons=[];$.each(buttons,(function(){if(this.data("target")){content_buttons.push(this.data("target"))}}));toolbar.html("").append(buttons)}}function register_cloned_button(old_id,new_id,active_class){var button=find_button(old_id);if(button){rcmail.register_button(button.command,new_id,button.data.type,active_class,button.data.sel)}}function create_cloned_button(target,menu_button,add_class,always_active){var popup,click=true,button=$("<a>"),target_id=target.attr("id")||(new Date).getTime(),button_id=target_id+"-clone",btn_class=target[0].className+(add_class?" "+add_class:"");if(!menu_button){btn_class=btn_class.replace("btn-primary","primary").replace(/(btn[a-z-]*|button|disabled)/g,"").trim();btn_class+=" button"+(!always_active?" disabled":"")}else if(popup=target.data("popup")){button.data({popup:popup,"toggle-button":target.data("toggle-button")});popup_init(button[0]);click=false;rcmail.register_menu_button(button[0],popup)}button.attr({id:button_id,href:"#",class:btn_class}).append($('<span class="inner">').text(target.text()));if(click){button.on("click",(function(e){target.click()}))}if(is_framed&&!menu_button){button.data("target",target);frame_buttons.push($.extend({button_id:button_id},find_button(target[0].id)))}else{register_cloned_button(target_id,button_id,btn_class.replace(" disabled",""))}return button}function find_button(id){var i,button,command;for(command in rcmail.buttons){for(i=0;i<rcmail.buttons[command].length;i++){button=rcmail.buttons[command][i];if(button.id==id){return{command:command,index:i,data:button}}}}}function layout_init(){color_mode_init();env.last_selected=$("#layout > div.selected")[0];if(!env.last_selected&&layout.content.length){$.each(["sidebar","list","content"],(function(){if(layout[this].length){env.last_selected=layout[this][0];layout[this].addClass("selected");return false}}))}$(window).on("resize",(function(){clearTimeout(env.resize_timeout);env.resize_timeout=setTimeout((function(){resize()}),25)}));env.open_window=rcmail.open_window;rcmail.open_window=window_open;rcmail.addEventListener("message",message_displayed).addEventListener("menu-open",menu_toggle).addEventListener("menu-close",menu_toggle).addEventListener("editor-init",tinymce_init).addEventListener("autocomplete_create",rcmail_popup_init).addEventListener("googiespell_create",rcmail_popup_init).addEventListener("setquota",update_quota).addEventListener("enable-command",enable_command_handler).addEventListener("destroy-entity-selector",(function(o){menu_destroy(o.name)})).addEventListener("clonerow",pretty_checkbox_fix).addEventListener("init",init);if((layout.list.length||layout.content.length)&&is_mobile()){var fabuttons=[];$("[data-fab]").each((function(){var button=$(this),task=button.data("fab-task")||"*",action=button.data("fab-action")||"*";if((task=="*"||task==rcmail.env.task)&&(action=="*"||action==rcmail.env.action||action=="none"&&!rcmail.env.action)){fabuttons.push(create_cloned_button(button,false,false,true))}}));if(fabuttons.length){$('<div class="floating-action-buttons">').append(fabuttons).appendTo(layout.list.length?layout.list:layout.content)}}if(layout.sidebar.length){splitter_init(layout.sidebar)}if(layout.list.length){splitter_init(layout.list)}}function init(){$("[data-list]").filter("ul,table").each((function(){var table=$(this),list=table.data("list");if(rcmail[list]&&rcmail[list].multiselect){var repl,button,parent=table.parents("layout-sidebar,#layout-list,#layout-content").last(),header=parent.find(".header"),toolbar=header.find("ul");if(!toolbar.length){toolbar=header}else if(button=toolbar.find("a.select").data("toggle-button")){button=$("#"+button)}rcmail[list].enable_checkbox_selection();if(get_pref("list-selection")===true){table.addClass("withselection")}if(!button){button=$("<a>").attr({class:"button selection disabled",role:"button",title:rcmail.gettext("select")}).on("click",(function(){UI.toggle_list_selection(this,table.attr("id"))})).append($('<span class="inner">').text(rcmail.gettext("select")));if(toolbar.is(".menu")){button.prependTo(toolbar).wrap('<li role="menuitem">');if(layout.content){var button2=create_cloned_button(button,true,"hidden-big hidden-large");$('<li role="menuitem">').append(button2).appendTo("#toolbar-menu");button=button.add(button2)}}else{if(repl=table.data("list-select-replace")){$(repl).replaceWith(button)}else{button.appendTo(toolbar).addClass("icon");if(!parent.is("#layout-sidebar")){button.addClass("toolbar-button")}}}}rcmail.addEventListener("listupdate",(function(prop){if(prop.list&&prop.list==rcmail[list]){if(prop.rowcount){button.addClass("active").removeClass("disabled").attr("tabindex",0)}else{button.removeClass("active").addClass("disabled").attr("tabindex",-1)}}}))}if(touch&&rcmail[list]){if(typeof rcmail[list].draggable=="function"){rcmail[list].draggable("destroy")}else if(typeof rcmail[list].draggable=="boolean"){rcmail[list].draggable=false}rcmail[list].dblclick_time=0}}));if(window.MutationObserver){$("[data-label-msg]").filter("ul,table").each((function(){var info=$('<div class="listing-info hidden">').insertAfter(this),table=$(this),fn=function(){var ext,command,msg=table.data("label-msg"),list=table.is("ul")?table:table.children("tbody");if(!rcmail.env.search_request&&!rcmail.env.qsearch&&msg&&!list.children(":visible").length){ext=table.data("label-ext");command=table.data("create-command");if(ext&&(!command||rcmail.commands[command])){msg+=" "+ext}info.text(msg).removeClass("hidden");return}info.addClass("hidden")},callback=function(){if(rcmail.busy||!table.is(":visible")){return setTimeout(callback,250)}clearTimeout(env.list_timer);env.list_timer=setTimeout(fn,50)};var observer=new MutationObserver(callback);observer.observe(table[0],{childList:true,subtree:true,attributes:true,attributeFilter:["style"]});callback()}))}if(rcmail.env.action!="print"){$("#attachment-list > li").each((function(){attachmentmenu_append(this)}))}var phone_confirmation=function(label){if(mode=="phone"){rcmail.display_message(rcmail.gettext(label),"confirmation")}};rcmail.addEventListener("fileappended",(function(e){if(e.attachment.complete){attachmentmenu_append(e.item);if(e.attachment.mimetype=="text/vcard"&&rcmail.commands["attach-vcard"]){phone_confirmation("vcard_attachments.vcardattached")}}})).addEventListener("managesieve.insertrow",(function(o){bootstrap_style(o.obj)})).addEventListener("add-recipient",(function(){phone_confirmation("recipientsadded")}));rcmail.init_pagejumper(".pagenav > input");if(rcmail.task=="mail"){if(rcmail.env.action=="compose"){rcmail.addEventListener("compose-encrypted",(function(e){$("a.mode-html, button.attach").prop("disabled",e.active);$("a.attach, a.responses:not(.edit)")[e.active?"addClass":"removeClass"]("disabled")}));$("#layout-sidebar > .footer:not(.pagenav) > a.button").click((function(){if($(this).is(".disabled")){rcmail.display_message(rcmail.gettext("nocontactselected"),"warning")}}));if(window.MutationObserver){var observer,list=$("#attachment-list"),status_callback=function(){compose_status("attach",list.children().length>0)};observer=new MutationObserver(status_callback);observer.observe(list[0],{childList:true});status_callback()}}if(!rcmail.env.extwin&&(rcmail.env.action=="compose"||rcmail.env.action=="show")){$("a.mail",layout.menu).attr({"aria-disabled":false,onclick:"return rcmail.command('list','',this,event);"})}if(rcmail.env.action=="preview"||rcmail.env.action=="show"){$("a").filter('[href^="mailto:"]').each((function(){mailtomenu_append(this)}));headers_show()}}else if(rcmail.task=="settings"){rcmail.addEventListener("identity-encryption-show",(function(p){bootstrap_style(p.container)}));rcmail.addEventListener("identity-encryption-update",(function(p){bootstrap_style(p.container)}))}rcmail.set_env({thread_padding:"1.5rem",popup_width_small:1025,popup_width:1200});if(rcmail.env.devel_mode&&window.less){less.pageLoadFinished.then((function(){resize();if(rcmail.env.compose_focus_elem){$(rcmail.env.compose_focus_elem).focus()}}))}else{resize()}var func,format=rcmail.env.date_format_localized;if(format){func=function(input){$(input).filter(".datepicker").attr("placeholder",format);$(input).parent().find("select").each((function(){pretty_select(this)}))};$("input.datepicker").each((function(){func(this)}));rcmail.addEventListener("insert-edit-field",func)}}function color_mode_init(){if(rcmail.env.action=="print"){return}var pref=rcmail.get_cookie("colorMode"),color_scheme=window.matchMedia("(prefers-color-scheme: dark)"),reset_cookie=function(){rcmail.set_cookie("colorMode","",new Date)},switch_iframe_color_mode=function(){try{$(this.contentWindow.document).find("html")[color_mode=="dark"?"addClass":"removeClass"]("dark-mode")}catch(e){}},switch_color_mode=function(){if(color_mode=="dark"){$("#taskmenu a.theme").removeClass("dark").addClass("light").find("span").text(rcmail.gettext("lightmode"));$("html").addClass("dark-mode")}else{$("#taskmenu a.theme").removeClass("light").addClass("dark").find("span").text(rcmail.gettext("darkmode"));$("html").removeClass("dark-mode")}screen_logo(mode);$("iframe").each(switch_iframe_color_mode)};if(rcmail.env.dark_mode_support===false){if(pref=="dark"){reset_cookie();$("iframe").each(switch_iframe_color_mode)}return}$("#taskmenu a.theme").on("click",(function(){color_mode=$(this).is(".dark")?"dark":"light";switch_color_mode();rcmail.set_cookie("colorMode",color_mode,false)}));color_scheme.addListener((function(e){color_mode=e.matches?"dark":"light";switch_color_mode();reset_cookie()}));if(pref){color_mode=pref}else if(color_scheme.matches){color_mode="dark"}switch_color_mode();$("iframe").on("load",switch_iframe_color_mode)}function bootstrap_style(context){if(!context){context=document}$("input.button,button",context).not(".btn").addClass("btn").not(".btn-primary,.primary,.mainaction").addClass("btn-secondary");$("input.button.mainaction,button.primary,button.mainaction",context).addClass("btn-primary");$("button.btn.delete,button.btn.discard",context).addClass("btn-danger");$.each(["warning","error","information","confirmation"],(function(){var type=this;$(".box"+type+":not(.ui.alert)",context).each((function(){alert_style(this,type,true)}))}));if(context!=document&&$(".popup",context).children().length==1){var content=$(".popup",context).children().first();if(content.is("img")){$(".popup",context).addClass("justified")}else if(content.is("label")){var input=content.find("input").detach(),label=content.detach(),id=input.attr("id");if(!id){input.attr("id",id="dialog-input-elastic")}$(".popup",context).addClass("formcontent").append($('<div class="form-group row">').append(label.attr("for",id).addClass("col-sm-2 col-form-label")).append($('<div class="col-sm-10">').append(input)));input.focus()}}var supported_controls="input:not(.button,.no-bs,[type=button],[type=radio],[type=checkbox],[type=file]),textarea";$(supported_controls,$(".propform",context)).addClass("form-control");$("[type=checkbox]",$(".propform",context)).addClass("form-check-input");$("select",context).addClass("form-control custom-select");if(context!=document){$(supported_controls,context).addClass("form-control")}$("table.propform",context).each((function(){var text_rows=0,form_rows=0;var col_sizes=["sm",4,8];if($(this).attr("class").match(/cols-([a-z]+)-(\d)-(\d)/)){col_sizes=[RegExp.$1,RegExp.$2,RegExp.$3]}$(this).find("> tbody > tr, > tr").each((function(){var first,last,row=$(this),row_classes=["form-group","row"],cells=row.children("td");if(cells.length==2){first=cells.first();last=cells.last();$("label",first).addClass("col-form-label");first.addClass("col-"+col_sizes[0]+"-"+col_sizes[1]);last.addClass("col-"+col_sizes[0]+"-"+col_sizes[2]);if(last.find("[type=checkbox]").length==1&&!last.find(".proplist").length){row_classes.push("form-check");if(last.find("a").length){row_classes.push("with-link")}form_rows++}else if(!last.find("input:not([type=hidden]),textarea,radio,select").length){last.addClass("form-control-plaintext");text_rows++}else{form_rows++}if(last.children(".datepicker")&&last.children("input").length==2){last.addClass("datetime")}}else if(cells.length==1){cells.css("width","100%")}row.addClass(row_classes.join(" "))}));if(text_rows>form_rows){$(this).addClass("text-only")}}));$("td.input-group",context).each((function(){$(this).children().slice(1).addClass("input-group-append")}));$("fieldset.propform:not(.grouped) div.row",context).each((function(){var has_input=$("input:not([type=hidden]),select,textarea",this).length>0;if(has_input){$(supported_controls,this).addClass("form-control")}$(this).children().last().addClass("col-sm-8"+(!has_input?" form-control-plaintext":""));$(this).children().first().addClass("col-sm-4 col-form-label");$(this).addClass("form-group")}));$("fieldset.propform.grouped fieldset",context).each((function(){$(".row",this).each((function(){var label,first,has_input=$("input,select,textarea",this).length>0,items=$(this).children();if(has_input){$(supported_controls,this).addClass("form-control")}if(items.length<2){return}first=items.first();if(first.is("select")){first.addClass("input-group-prepend")}else{first.wrap('<span class="input-group-prepend">').addClass("input-group-text")}if(!has_input){items.last().addClass("form-control-plaintext")}$(".content",this).addClass("input-group-prepend input-group-append input-group-text");$("a.deletebutton",this).addClass("input-group-text icon delete").wrap('<span class="input-group-append">');$(this).addClass("input-group")}))}));$("fieldset.advanced",context).each((function(){var table=$(this).children(".propform").first();table.wrap($("<div>").addClass("collapse"));$(this).children("legend").first().addClass("closed").on("click",(function(){table.parent().collapse("toggle");$(this).toggleClass("closed")}))}));$(".propform > .prop.block:not(.row)",context).each((function(){$(this).addClass("form-group row").each((function(){$("label",this).addClass("col-form-label").wrap($('<div class="col-sm-4">'));$("input,select,textarea",this).wrap($('<div class="col-sm-8">'));$(supported_controls,this).addClass("form-control")}))}));$("td.rowbuttons > a",context).addClass("btn");$("form.tabbed,div.tabbed",context).each((function(idx,item){var tabs=[],nav=$("<ul>").attr({class:"nav nav-tabs",role:"tablist"});$(this).addClass("tab-content").children("fieldset").each((function(i,fieldset){var tab,id=fieldset.id||"tab"+idx+"-"+i,tab_class=$(fieldset).data("navlink-class");$(fieldset).addClass("tab-pane").attr({id:id,role:"tabpanel"});tab=$("<li>").addClass("nav-item").append($("<a>").addClass("nav-link"+(tab_class?" "+tab_class:"")).attr({role:"tab",href:"#"+id}).text($("legend",fieldset).first().text()).click((function(e){$(this).tab("show");popups_close(e);return false})));$("legend",fieldset).first().hide();tabs.push(tab)}));nav.append(tabs).insertBefore(item);$("a.nav-link",nav).first().click()}));$("input[type=file]:not(.custom-file-input)",context).each((function(){var label_text=rcmail.gettext("choosefile"+(this.multiple?"s":"")),label=$("<label>").attr({class:"custom-file-label","data-browse":rcmail.gettext("browse")}).text(label_text);$(this).addClass("custom-file-input").wrap('<div class="custom-file">');$(this).on("change",(function(){var text=label_text;if(this.files.length){text=this.files[0].name;if(this.files.length>1){text+=", ..."}}$(this).next().text(text)})).parent().append(label)}));$("table:not(.table,.compact-table,.propform,.listing,.ui-datepicker-calendar)",context).filter((function(){return!$(this).parent().is(".propform")&&!$(this).parents("#message-header,.message-htmlpart,.message-partheaders,.boxinformation,.raw-tables").length})).each((function(){var table=$(this).addClass("table");table.parent().addClass("table-responsive-sm");table.find("thead").addClass("thead-default")}));$("input.pretty-checkbox, .propform input[type=checkbox], .form-check input[type=checkbox], .popupmenu.form input[type=checkbox], .menu input[type=checkbox]",context).each((function(){pretty_checkbox(this)}));if($(context).is(".actionrow")){$("input[type=checkbox]",context).each((function(){pretty_checkbox(this)}))}$(".input-group-combo > select",context).first().on("change",(function(){var select=$(this),fn=function(){select[select.next().is(":visible")?"removeClass":"addClass"]("alone")};setTimeout(fn,50);setTimeout(fn,2e3)})).trigger("change");$("#message-objects",context).children(":not(.ui.alert)").add(".part-notice").each((function(){var cl=String($(this).removeClass("notice part-notice").attr("class")).split(/\s/)[0]||"warning";alert_style(this,cl);$(this).addClass("box"+cl);$("a",this).addClass("btn btn-primary btn-sm")}));$(".error",context).addClass("is-invalid");if(rcmail.env.task=="login"&&context==document){$("#rcmloginsubmit").addClass("btn-lg text-uppercase w-100");$("#rcmloginoauth").addClass("btn btn-secondary btn-lg w-100");$("#login-form table tr").each((function(){var input=$("input,select",this),label=$("label",this),icon_name=input.data("icon"),icon=$("<i>").attr("class","input-group-text icon "+input.attr("name").replace("_",""));if(icon_name){icon.addClass(icon_name)}$(this).addClass("form-group row");label.parent().css("display","none");input.addClass(input.is("select")?"custom-select":"form-control").attr("placeholder",label.text()).before($('<span class="input-group-prepend">').append(icon)).parent().addClass("input-group input-group-lg")}))}$("select:not([multiple])",context).each((function(){pretty_select(this)}))}function dropdowns_init(){$("[data-popup]").each((function(){popup_init(this)}));$(document).on("click",popups_close);rcube_webmail.set_iframe_events({mousedown:popups_close,touchstart:popups_close})}function content_frame_init(){if(!layout.list.length){return}var last_selected=env.last_selected,title_reset=function(title){if(typeof title!=="string"||!title.length){title=$("h1.voice").text()||$("title").text()||""}layout.content.find(".header > .header-title").text(title)};var common_content_handler=function(e,href,show,title){if(is_mobile()&&env.frame_nav){content_frame_navigation(href,e)}if(show&&!layout.content.is(":visible")){env.last_selected=layout.content[0]}else if(!show&&env.last_selected!=last_selected&&!env.content_lock){env.last_selected=last_selected}screen_resize();title_reset(title&&show?title:null);env.content_lock=false};var common_list_handler=function(e){if(mode!="large"&&!env.content_lock&&e.force){show_list()}env.content_lock=false;if(e.title){$(".header > .header-title",layout.list).text(e.title)}};var list_handler=function(e){var args={};if(rcmail.env.task=="addressbook"||rcmail.env.task=="mail"){args.force=true}if(rcmail.env.task=="mail"&&!rcmail.env.action){var name=$.type(e)=="string"?e:rcmail.env.mailbox,folder=rcmail.env.mailboxes[name];args.title=folder?folder.name:""}common_list_handler(args)};layout.content.find("iframe").on("load",(function(e){var win,href="",show=true;$(this).parent(".iframe-wrapper").scrollTop(0);try{win=e.target.contentWindow;href=win.location.href;show=!href.endsWith(rcmail.env.blankpage);$(win).on("unload",title_reset)}catch(e){}common_content_handler(e,href,show)}));rcmail.addEventListener("afterlist",list_handler).addEventListener("afterlistgroup",list_handler).addEventListener("afterlistsearch",list_handler).addEventListener("show-list",(function(e){e.force=true;common_list_handler(e)})).addEventListener("show-content",(function(e){if(e.obj&&!$(e.obj).is("iframe")){$(e.scrollElement||e.obj).scrollTop(0);if(is_mobile()){iframe_loader(e.obj)}}common_content_handler(e.event||new Event,"_action="+(e.mode||"edit"),true,e.title)}))}function content_frame_navigation(href,event){if(href.match(/_action=(create|add)/)||href.match(/_nav=hide/)){$(env.frame_nav).addClass("hide-nav-buttons");return}var node,uid,list,_list=$("[data-list]",layout.list).data("list");if(!_list||!(list=rcmail[_list])){if($(env.frame_nav).is(".hide-nav-buttons")&&!$(".buttons",env.frame_nav).children().length){$(env.frame_nav).addClass("hidden")}return}$(env.frame_nav).removeClass("hide-nav-buttons hidden");if(uid=list.get_single_selection()){if(list.rows&&list.rows[uid]&&!list.rows[uid].expanded){list.expand_row(event,uid)}else if(list.get_node&&(node=list.get_node(uid))&&node.collapsed){list.expand(uid)}}var prev,next,frame=$("#"+rcmail.env.contentframe),next_button=$("a.button.next",env.frame_nav).off("click").addClass("disabled"),prev_button=$("a.button.prev",env.frame_nav).off("click").addClass("disabled");if((next=list.get_next())||rcmail.env.current_page<rcmail.env.pagecount){next_button.removeClass("disabled").on("click",(function(){env.content_lock=true;iframe_loader(frame);if(next){list.select(next)}else{rcmail.env.list_uid="FIRST";rcmail.command("nextpage")}}))}if((prev=list.get_prev())&&(prev!="*"||_list!="subscription_list")||rcmail.env.current_page>1){prev_button.removeClass("disabled").on("click",(function(){env.content_lock=true;iframe_loader(frame);if(prev){list.select(prev)}else{rcmail.env.list_uid="LAST";rcmail.command("previouspage")}}))}}function tinymce_init(o){var onload=[],is_editor=$("#"+o.id).parent().is(".html-editor");o.config.plugins+=" autoresize";if(is_touch()){o.config.toolbar="undo redo | link image styleselect"}if(rcmail.task=="mail"&&rcmail.env.action=="compose"){var floating=false,form=$("#compose-content > form"),keypress=function(e){if(e.key=="Tab"&&e.shiftKey){$("#compose-content > form").scrollTop(0)}};onload.push((function(ed){ed.on("keypress",keypress)}));$("#composebody").on("keypress",keypress);form.on("scroll",(function(){var container=$(".tox-editor-container",form),toolbar=container.find(".tox-toolbar-overlord"),editor_offset=container.offset(),header_top=form.offset().top;if(editor_offset&&editor_offset.top-header_top<0){toolbar.css({position:"fixed",top:header_top+"px",width:container.width()+"px"});floating=true}else{if(floating){$("#compose-subject").focus();floating=false}toolbar.css({position:"relative",top:0,width:"auto"})}}));$(window).resize((function(){form.trigger("scroll")}))}if(is_editor){o.config.toolbar="plaintext | "+o.config.toolbar;o.config.setup_callback=function(ed){ed.ui.registry.addButton("plaintext",{tooltip:rcmail.gettext("plaintoggle"),icon:"close",onAction:function(e){if(rcmail.command("toggle-editor",{id:ed.id,html:false},"",e.originalEvent)){$("#"+ed.id).parent().removeClass("ishtml")}}})}}onload.push((function(ed){ed.on("OpenWindow",(function(e){var dialog=$(".tox-dialog:last")[0],callback=function(e){var body=$(dialog).find(".tox-dialog__body"),foot=$(dialog).find(".tox-dialog__footer"),buttons=foot.find("button");if(!e){if(buttons.length===4){body.closest(".tox-dialog").addClass("tox-search-dialog")}else if(buttons.length==2){buttons.first().insertAfter(buttons[1])}}body.find(".tox-checkbox > input").each((function(){pretty_checkbox(this)}));body.find(".tox-textarea,.tox-textfield").addClass("form-control")};if(window.MutationObserver){new MutationObserver(callback).observe($(".tox-dialog__body-content",dialog)[0],{childList:true})}callback()}))}));rcmail.addEventListener("editor-load",(function(e){$.each(onload,(function(){this(e.ref.editor)}))}))}function datepicker_init(datepicker){if(window.MutationObserver){$(datepicker).not("[data-observed]").each((function(){var overlay,hidden=true,win=is_framed?parent:window,callback=function(data){$.each(data,(function(i,v){if(v.type=="attributes"){var is_hidden=$(v.target).attr("aria-hidden")=="true";if(is_hidden!=hidden){if(!is_hidden){overlay=$("<div>").attr("class","ui-widget-overlay datepicker").appendTo(win.document.body).click((function(e){$(this).remove();if(is_framed){$.datepicker._hideDatepicker()}}))}else if(overlay){overlay.remove()}hidden=is_hidden}}else if(v.addedNodes.length){win.UI.bootstrap_style(v.target);if(is_framed){win.$("select.ui-datepicker-month",v.target).on("change",(function(){$.datepicker._selectMonthYear($.datepicker._lastInput,this,"M")}));win.$("select.ui-datepicker-year",v.target).on("change",(function(){$.datepicker._selectMonthYear($.datepicker._lastInput,this,"Y")}))}}}))};$(this).attr("data-observed","1");if(is_framed){$(this).detach().appendTo(parent.document.body);$('<div id="ui-datepicker-div" class="hidden">').appendTo(document.body)}new MutationObserver(callback).observe(this,{childList:true,subtree:false,attributes:true,attributeFilter:["aria-hidden"]})}))}}function toggle_list_selection(obj,list_id){if($(obj).is(".active")){set_pref("list-selection",$("#"+list_id).toggleClass("withselection").is(".withselection"))}}function rcmail_popup_init(o){$("ul",o.obj).addClass("menu listing iconized");$(o.obj).addClass("popupmenu popover");bootstrap_style(o.obj);$("input",o.obj).addClass("form-control");if(is_mobile()&&$(o.obj).is(".googie_window")){var title=rcmail.gettext("close"),class_name="button icon cancel",close_link=$("<a>").attr("class",class_name).text(title).click((function(e){e.stopPropagation();$(".popover-overlay").remove();$(o.obj).hide()}));$('<h3 class="popover-header">').append(close_link).prependTo(o.obj);if(!$(".popover-overlay").length){$("<div>").attr("class","popover-overlay").appendTo("body").click((function(){$(this).remove()}))}$("ul,button",o.obj).click((function(e){if(!$(e.target).is("input")){$(".popover-overlay").remove()}}))}}function enable_command_handler(args){if(is_framed){$.each(frame_buttons,(function(i,button){if(args.command==button.command){parent.$("#"+button.button_id)[args.status?"removeClass":"addClass"]("disabled")}}))}if(rcmail.task=="mail"){switch(args.command){case"reply-list":if(rcmail.env.reply_all_mode==1){var label=rcmail.gettext(args.status?"replylist":"replyall");$(".toolbar a.reply-all").attr("title",label).find(".inner").text(label)}break;case"compose-encrypted":$(".toolbar a.encrypt").parent().show();break;case"compose-encrypted-signed":$("#encryption-menu-button").show();break}}}function screen_mode(){var size,width=$(window).width();if(width<=480)size="phone";else if(width>1200)size="large";else if(width>768)size="normal";else size="small";touch=width<=1024;mode=size}function get_screen_mode(){return mode}function resize(){var mobile;screen_mode();screen_resize();screen_resize_html();if(mobile=is_mobile()){rcmail.set_env(env.small_screen_config);rcmail.enable_command("extwin",false)}else{rcmail.set_env(env.config);rcmail.enable_command("extwin",true)}$.each(content_buttons,(function(){$(this)[mobile?"hide":"show"]()}));rcmail.triggerEvent("skin-resize",{mode:mode})}function screen_resize(){if(is_framed&&!layout.sidebar.length&&!layout.list.length){screen_resize_headers();return}switch(mode){case"phone":screen_resize_phone();break;case"small":screen_resize_small();break;case"normal":screen_resize_normal();break;case"large":screen_resize_large();break}screen_logo(mode);screen_resize_headers();if(bw.webkit&&bw.ipad&&bw.agent.match(/OS 9/)){$(".iframe-wrapper").each((function(){var h=$(this).height();if(h){$(this).children("iframe").height(h)}}))}}function screen_resize_html(){var meta=layout_metadata(),html=$(document.documentElement);if(html[0].className.match(/layout-([a-z]+)/)){if(RegExp.$1!=meta.mode){html.removeClass("layout-"+RegExp.$1).addClass("layout-"+meta.mode)}}else{html.addClass("layout-"+meta.mode)}if(meta.touch&&!html.is(".touch")){html.addClass("touch")}else if(!meta.touch&&html.is(".touch")){html.removeClass("touch")}}function screen_logo(mode){var logos=rcmail.env.additional_logos;if(logos){if(!$("#logo").data("src-default")){$("#logo").data("src-default",$("#logo").attr("src"))}if(mode=="phone"&&color_mode=="dark"&&logos["small-dark"]){$("#logo").attr("src",logos["small-dark"])}else if(mode=="phone"&&logos["small"]){$("#logo").attr("src",logos["small"])}else if(color_mode=="dark"&&logos["dark"]){$("#logo").attr("src",logos["dark"])}else{$("#logo").attr("src",$("#logo").data("src-default"))}}}function screen_resize_headers(){$("#layout > div > .header").each((function(){var title,right=0,left=0,padding=0,sizes={left:0,right:0};$(this).children(":visible:not(.position-absolute)").each((function(){if(!title&&$(this).is(".header-title")){title=$(this);return}sizes[title?"right":"left"]+=this.offsetWidth}));if(padding+sizes.right>=sizes.left){right=0;left=sizes.right+padding-sizes.left}else{left=0;right=sizes.left-(padding+sizes.right)}$(title).css({"margin-right":right+"px","margin-left":left+"px","padding-right":padding+"px"})}))}function screen_resize_phone(){screen_resize_small_all();app_menu(false)}function screen_resize_small(){screen_resize_small_all();app_menu(true)}function screen_resize_normal(){var show;if(layout.list.length){show=layout.list.is(env.last_selected)||!layout.sidebar.is(env.last_selected)&&!layout.sidebar.is(".layout-sticky");layout.list[show?"removeClass":"addClass"]("hidden")}if(layout.sidebar.length){show=!layout.list.length||layout.sidebar.is(env.last_selected)||layout.sidebar.is(".layout-sticky");layout.sidebar[show?"removeClass":"addClass"]("hidden")}layout.content.removeClass("hidden");app_menu(true);screen_resize_small_none();if(layout.list.length){$(".header > ul.menu",layout.list).addClass("popupmenu")}}function screen_resize_large(){$.each(layout,(function(name,item){item.removeClass("hidden")}));screen_resize_small_none();if(layout.list){$(".header > ul.menu.popupmenu",layout.list).removeClass("popupmenu")}}function screen_resize_small_all(){var show,got_content=false;if(layout.content.length){show=got_content=layout.content.is(env.last_selected);layout.content[show?"removeClass":"addClass"]("hidden");$(".header > ul.menu",layout.content).addClass("popupmenu")}if(layout.list.length){show=!got_content&&layout.list.is(env.last_selected);layout.list[show?"removeClass":"addClass"]("hidden");$(".header > ul.menu",layout.list).addClass("popupmenu")}if(layout.sidebar.length){show=!got_content&&(layout.sidebar.is(env.last_selected)||!layout.list.length);layout.sidebar[show?"removeClass":"addClass"]("hidden")}if(got_content){buttons.back_list.show()}}function screen_resize_small_none(){buttons.back_list.filter((function(){return $(this).parents("#layout-sidebar").length==0})).hide();$("ul.menu.popupmenu").removeClass("popupmenu")}function show_content(unsticky){layout.list.addClass("hidden");layout.sidebar.addClass("hidden");layout.content.removeClass("hidden");if(unsticky){layout.sidebar.removeClass("layout-sticky")}screen_resize_headers();env.last_selected=layout.content[0]}function show_sidebar(sticky){layout.list.addClass("hidden");layout.sidebar.removeClass("hidden");if(sticky){layout.sidebar.addClass("layout-sticky")}if(mode=="small"||mode=="phone"){layout.content.addClass("hidden")}screen_resize_headers();env.last_selected=layout.sidebar[0]}function show_list(scroll){if(!layout.list.length&&!layout.sidebar.length){history.back()}else{layout.sidebar.addClass("hidden").removeClass("layout-sticky");layout.list.removeClass("hidden");if(mode=="small"||mode=="phone"){hide_content()}if(scroll){layout.list.children(".scroller").scrollTop(0)}env.last_selected=layout.list[0]}screen_resize_headers()}function hide_content(){env.last_selected=layout.list[0]||layout.sidebar[0];screen_resize();rcmail.show_contentframe(false);$("[data-list]",layout.list).each((function(){var list=$(this).data("list");if(rcmail[list]){if(rcmail[list].clear_selection){rcmail[list].clear_selection()}else if(rcmail[list].select){rcmail[list].select()}}}))}function app_menu(show){if(show){if(mode=="phone"){$('<div id="menu-overlay" class="popover-overlay">').on("click",(function(){app_menu(false)})).appendTo("body");if(!env.menu_initialized){env.menu_initialized=true;$("a",layout.menu).on("click",(function(e){if(mode=="phone")app_menu()}))}layout.menu.addClass("popover")}layout.menu.removeClass("hidden")}else{$("#menu-overlay").remove();layout.menu.addClass("hidden").removeClass("popover")}}function message_displayed(p){if(p.type=="loading"&&$(".iframe-loader:visible").length){rcmail.hide_message(p.object);return}alert_style(p.object,p.type,true);$(p.object).attr("role","alert")}function alert_style(object,type,wrap){var tmp,classes="ui alert",addicon=!$(object).is(".noicon"),map={information:"alert-info",notice:"alert-info",confirmation:"alert-success",warning:"alert-warning",error:"alert-danger",loading:"alert-info loading",uploading:"alert-info loading",vcardattachment:"alert-info"};if(wrap&&addicon&&!$(object).is(".aligned-buttons")){$(object).html($("<span>").html($(object).html()))}type=type.split(" ")[0];if(tmp=map[type]){classes+=" "+tmp;if(addicon){$("<i>").attr("class","icon").prependTo(object)}}$(object).addClass(classes)}function dialog_open(dialog){var me=$(dialog.uiDialog),width=me.width(),height=me.height(),maxWidth=$(window).width(),maxHeight=$(window).height();if(maxWidth<=480){me.css({width:"100%",height:"100%"})}else{if(height>maxHeight){me.css("height","100%")}if(width>maxWidth){me.css("width","100%")}}$(document).click();iframe_loader($("div.popup > iframe",me));bootstrap_style(dialog.uiDialog)}function searchbar_init(bar){var unread_button=$(),options_button=$("a.button.options",bar),input=$("input:not([type=hidden])",bar),placeholder=input.attr("placeholder"),form=$("form",bar),is_search_pending=function(){if(input.val()){return true}if(rcmail.task=="mail"&&$("#s_interval").val()){return true}if(rcmail.gui_objects.search_filter&&$(rcmail.gui_objects.search_filter).val()!="ALL"){return true}if(rcmail.gui_objects.foldersfilter&&$(rcmail.gui_objects.foldersfilter).val()!="---"){return true}},close_func=function(){if($(bar).is(".open")){options_button.click()}},update_func=function(){$(bar)[is_search_pending()?"addClass":"removeClass"]("active");unread_button[rcmail.gui_objects.search_filter&&$(rcmail.gui_objects.search_filter).val()=="UNSEEN"?"addClass":"removeClass"]("selected")};if(input.is("#mailsearchform")){unread_button=$("<a>").attr({class:"button unread",href:"#",role:"button",title:rcmail.gettext("showunread")}).on("click",(function(e){$(rcmail.gui_objects.search_filter).val($(e.target).is(".selected")?"ALL":"UNSEEN");rcmail.command("search")})).insertBefore(options_button)}options_button.on("click",(function(e){var id=$(this).data("target"),options=$("#"+id),open=$(bar).is(".open");if(options.length){if(!open){if(ref[id]){ref[id](options.get(0),this,e)}else if(typeof window[id]=="function"){window[id](options.get(0),this,e)}}options.next()[open?"show":"hide"]();options.toggleClass("hidden");$(".floating-action-buttons").toggleClass("hidden");$(bar).toggleClass("open");$("button.search",options).off("click.search").on("click.search",(function(){options_button.click();update_func()}))}}));input.on("input change",update_func).on("focus blur",(function(e){input.attr("placeholder",e.type=="blur"?placeholder:"")}));$("a.reset",bar).on("click",(function(e){input.val("").change().trigger("keyup.treelist",{keyCode:27});if($(bar).is(".open")){options_button.click()}if(rcmail.gui_objects.search_filter){$(rcmail.gui_objects.search_filter).val("ALL")}if(rcmail.gui_objects.foldersfilter){$(rcmail.gui_objects.foldersfilter).val("---").change();rcmail.folder_filter("---")}update_func()}));rcmail.addEventListener("init",update_func).addEventListener("responsebeforesearch",update_func).addEventListener("beforelist",close_func).addEventListener("afterlist",update_func).addEventListener("beforesearch",close_func)}function toolbar_init(){if(env.got_smart_toolbar){return}env.got_smart_toolbar=true;var list_mark,items=[],list_items=[],meta=layout_metadata(),button_func=function(button,items,cloned){var item=$('<li role="menuitem">');button=cloned?create_cloned_button($(button),true,"hidden-big hidden-large"):$(button).detach();button.contents().filter((function(){if(this.nodeType==3&&this.nodeValue.trim().length==0)$(this).remove()}));if(button.is(".spacer")){item.addClass("spacer")}else{item.append(button)}items.push(item)};layout.content.find(".header > .menu").each((function(){var toolbar=$(this);toolbar.children().each((function(){button_func(this,items)}));toolbar.remove()}));layout.list.find(".header > .menu").each((function(){var toolbar=$(this);list_mark=toolbar.next();toolbar.children().each((function(){if(meta.mode!="large"){$(this).data("popup-pos","right")}button_func(this,items,true);button_func(this,list_items)}));toolbar.remove()}));$('ul[data-menu="toolbar-small"] > li > a').each((function(){var button=$(this).clone();button.attr("id",this.id+"_clone");items.push($('<li role="menuitem">').addClass("hidden-big").append(button))}));if(list_items.length){var container=layout.list.children(".header"),menu_attrs={class:"menu toolbar popupmenu listing iconized",id:"toolbar-list-menu"},menu_button=$('<a class="button icon toolbar-list-button" href="#list-menu">').attr({"data-popup":"toolbar-list-menu"}),toolbar=$("<ul>").attr(menu_attrs).data("popup-parent",container).append(list_items);if(list_mark.length){toolbar.insertBefore(list_mark)}else{container.append(toolbar)}container.append(menu_button)}if(items.length){var container=layout.content.children(".header"),menu_attrs={class:"menu toolbar popupmenu listing iconized",id:"toolbar-menu"},menu_button=$('<a class="button icon toolbar-menu-button" href="#menu">').attr({"data-popup":"toolbar-menu"});container.append($("<ul>").attr(menu_attrs).data("popup-parent",container).append(items)).append(menu_button);layout.list.find("a.toolbar-menu-button").click((function(e){e.stopPropagation();menu_button.click()}))}}function popup_init(item,win){if(is_framed&&is_mobile()){return parent.UI.popup_init(item,win||window)}if(!win)win=window;var level,popup_id=$(item).data("popup"),popup=$(win.$("#"+popup_id).get(0)),popup_orig=popup,title=$(item).attr("title"),content_element=function(){if(win!=window){popup=popup_orig.clone(true,true);popup.attr("id",popup_id+"-clone").appendTo(document.body).find("li > a").attr("onclick","").off("click").on("click",(function(e){if(!$(this).is(".disabled")){$(item).popover("hide");win.$("#"+$(this).attr("id")).click()}return false}))}return popup.get(0)};$(item).attr({"aria-haspopup":"true","aria-expanded":"false","aria-owns":popup_id}).popover({content:content_element,trigger:$(item).data("popup-trigger")||"click",placement:$(item).data("popup-pos")||"bottom",animation:true,boundary:"window",html:true}).on("show.bs.popover",(function(event){var init_func=popup.data("popup-init");if(popup_id&&menus[popup_id]){menus[popup_id].transitioning=true}if(init_func&&ref[init_func]){ref[init_func](popup.get(0),item,event)}else if(init_func&&win[init_func]){win[init_func](popup.get(0),item,event)}level=$("div.popover:visible").length+1;popup.removeClass("hidden").attr("aria-hidden",false).find('[aria-haspopup="true"]').data("level",level+1).off("click.popup").on("click.popup",(function(e){e.stopPropagation()}));if(!is_mobile()){popup.css("max-height",Math.min(36*15-1,$(window).height()-30))}})).on("shown.bs.popover",(function(event){var mobile=is_mobile(),popover=$("#"+$(item).attr("aria-describedby"));level=$(item).data("level")||1;if(mobile){var label=level>1?"back":"close",title=rcmail.gettext(label),class_name="button icon "+(label=="back"?"back":"cancel");$(".popover-header",popover).empty().append($("<a>").attr("class",class_name).text(title).on("click",(function(e){$(item).popover("hide");if(level>1){e.stopPropagation()}})).on("mousedown",(function(e){e.stopPropagation()})))}$.each(menus,(function(id,prop){if($(prop.target).data("level")==level&&id!=popup_id){menu_hide(id)}}));if($(item).data("event")=="key"){popover.off("keydown.popup").on("keydown.popup","a.active",(function(e){var entry,node,mode="next";switch(e.which){case 27:case 9:$(item).popover("toggle").focus();return false;case 38:case 63232:mode="previous";case 40:case 63233:entry=e.target.parentNode;while(entry=entry[mode+"Sibling"]){if(node=$(entry).children(".active")[0]){node.focus();break}}return false}}));popover.find("a.active").first().focus()}if(popup_id&&menus[popup_id]){menus[popup_id].transitioning=false}if(mobile&&!$(".popover-overlay").length){$("<div>").attr("class","popover-overlay").appendTo("body").click((function(){$(this).remove()}))}$(".popover-body",popover).addClass("webkit-scroller")})).on("hide.bs.popover",(function(){if(level==1){$(".popover-overlay").remove()}if(popup_id&&menus[popup_id]&&popup.is(":visible")){menus[popup_id].transitioning=true}})).on("hidden.bs.popover",(function(){if(/-clone$/.test(popup.attr("id"))){popup.remove()}else{popup.attr("aria-hidden",true).addClass("hidden").appendTo(popup.data("popup-parent")||document.body)}$(".popover-body:empty").each((function(){$(this).parent().remove()}));if(popup_id&&menus[popup_id]){delete menus[popup_id]}})).on("click",(function(){$(this).data("event","mouse")})).on("keydown",(function(e){if(e.originalEvent){switch(e.originalEvent.which){case 13:case 32:e.preventDefault();$(this).data("event","key").popover("toggle");break;case 27:$(this).popover("hide");break}}}));if(title){$(item).attr("title",title)}popup.attr("aria-hidden","true").data("button",item);if(popup.data("editable")){popup.on("click mousedown",(function(e){e.stopPropagation()}))}}function popups_close(e){if(popups_close_lock&&popups_close_lock>(new Date).getTime()-250){return}$(".popover.show").each((function(){var popup=$(".popover-body",this),button=popup.children().first().data("button");if(button&&e.target!=button&&!$(button).find(e.target).length&&typeof button!=="string"){$(button).popover("hide")}if(!button){$(this).remove()}}))}function menu_toggle(p){if(!p||!p.name||p.props&&p.props.skinable===false){return}if(is_framed&&is_mobile()){if(!p.win){p.win=window}return parent.UI.menu_toggle(p)}if(p.name=="messagelistmenu"){menu_messagelist(p)}else if(p.event=="menu-open"){var fn,pos,content=$("ul",p.obj).first(),target=p.props&&p.props.link?p.props.link:p.originalEvent.target;if(!content.length){return}if($(target).is("span")){target=$(target).parents("a,li")[0]}if(p.name.match(/^drag/)){pos=rcube_event.get_mouse_pos(p.originalEvent);target=$("<a>").css({position:"absolute",left:pos.x,top:pos.y,height:"1px",width:"1px",visibility:"hidden"}).appendTo(document.body).get(0)}pos=$(target).data("popup-pos")||"right";if(p.name=="folder-selector"){content.addClass("listing folderlist")}else if(p.name=="addressbook-selector"||p.name=="contactgroup-selector"){content.addClass("listing contactlist")}else if(content.hasClass("menu")){content.addClass("listing")}if(p.name=="pagejump-selector"){content.addClass("simplelist");p.obj.addClass("simplelist");pos="top"}if(menus[p.name]){menu_hide(p.name,p.originalEvent)}fn=function(){if(menus[p.name]&&menus[p.name].transitioning){return setTimeout(fn,50)}if(!$(target).data("popup")){$(target).data({event:rcube_event.is_keyboard(p.originalEvent)?"key":"mouse",popup:p.name,"popup-pos":pos,"popup-trigger":"manual"});popup_init(target,p.win)}menus[p.name]={target:target};setTimeout((function(){$(target).popover("show")}),1)};fn()}else{menu_hide(p.name,p.originalEvent)}p.originalEvent.stopPropagation()}function menu_hide(name,event){var target=menu_target(name);if(name.match(/^drag/)){$(target).popover("dispose").remove()}else{$(target).popover("hide");if(name=="forwardmenu"){popups_close(event)}}}function menu_destroy(name){$("[aria-owns="+name+"]").popover("dispose").data("popup",null)}function menu_target(name){var target;if(menus[name]){target=menus[name].target}else{target=$("#"+name).data("button");if(!target){if(name.match(/(?!-)menu$/)){name=name.substr(0,name.length-4)}target=$("#"+name+"-menu").data("button")}}return target}function menu_messagelist(p){var content=$("#listoptions-menu"),width=content.width()+25,dialog=content.clone(true);$('select[name="sort_col"]',dialog).val(rcmail.env.sort_col||"");$('select[name="sort_ord"]',dialog).val(rcmail.env.sort_order||"ASC");$('select[name="mode"]',dialog).val(rcmail.env.threading?"threads":"list");$("select",dialog).each((function(){this.id=this.id+"-clone"}));$("label",dialog).each((function(){$(this).attr("for",$(this).attr("for")+"-clone")}));var save_func=function(e){if(rcube_event.is_keyboard(e.originalEvent)){$("#listmenulink").focus()}var col=$('select[name="sort_col"]',dialog).val(),ord=$('select[name="sort_ord"]',dialog).val(),mode=$('select[name="mode"]',dialog).val();rcmail.set_list_options([],col,ord,mode=="threads"?1:0);return true};dialog=rcmail.simple_dialog(dialog,rcmail.gettext("listoptionstitle"),save_func,{closeOnEscape:true,minWidth:400})}function about_dialog(elem){var support_url,support_func,support_button=false,dialog=$("<iframe>").attr({id:"aboutframe",src:rcmail.url("settings/about",{_framed:1})}),support_link=$("#supportlink");if(support_link.length&&(support_url=support_link.attr("href"))){support_button=support_link.text();support_func=function(e){support_url.indexOf("mailto:")<0?window.open(support_url):location.href=support_url}}rcmail.simple_dialog(dialog,$(elem).text(),support_func,{button:support_button,button_class:"help",cancel_button:false,height:400})}function headers_show(toggle){var key="mail.show.envelope",pref=get_pref(key),show=toggle?!pref:pref,mode=show?"summary":"details",headers=$("div.header-content");$("div.header-links").find("a.headers-details,a.headers-summary").removeClass().addClass("headers-"+mode).text(rcmail.gettext(mode));headers[show?"addClass":"removeClass"]("details-view");if(toggle){set_pref(key,show)}}function headers_dialog(){var props={_uid:rcmail.env.uid,_mbox:rcmail.env.mailbox,_framed:1},dialog=$("<iframe>").attr({id:"headersframe",src:rcmail.url("headers",props)});rcmail.simple_dialog(dialog,rcmail.gettext("arialabelmessageheaders"),null,{cancel_button:"close",height:400})}function props_dialog(){var dialog=$("#properties-menu").clone();rcmail.simple_dialog(dialog,rcmail.gettext("properties"),null,{cancel_button:"close",height:400})}function import_dialog(){if(!rcmail.commands["import-messages"]){return}var content=$("#uploadform"),dialog=content.clone(true);var save_func=function(e){return rcmail.command("import-messages",$(dialog.find("form")[0]))};rcmail.simple_dialog(dialog,rcmail.gettext("importmessages"),save_func,{button:"import",closeOnEscape:true,minWidth:400})}function searchmenu(obj){var n,all="*",list=$('input[name="s_mods[]"]',obj),scope_select=$("#s_scope",obj),interval_select=$("#s_interval",obj),mbox=rcmail.env.mailbox,mods=rcmail.env.search_mods,scope=rcmail.env.search_scope||"base";if(!$(obj).data("initialized")){$(obj).data("initialized",true);if(list.length){list.on("change",(function(){set_searchmod(obj,this)}));rcmail.addEventListener("beforesearch",(function(){rcmail.env.search_scope=scope_select.val();rcmail.env.search_interval=interval_select.val()}))}}scope_select.val(scope);if(mods){if(rcmail.env.task=="mail"){mods=mods[mbox]||mods["*"];all="text"}if(mods[all]){list.map((function(){this.checked=true;this.disabled=this.value!=all}))}else{list.prop("disabled",false).prop("checked",false);for(n in mods){list.filter('[value="'+n+'"]').prop("checked",true)}}}}function set_searchmod(menu,elem){var all,m,task=rcmail.env.task,mods=rcmail.env.search_mods||{},mbox=rcmail.env.mailbox;if(task=="mail"){if(!mods[mbox]){mods[mbox]=rcube_clone_object(mods["*"])}m=mods[mbox];all="text"}else{m=mods;all="*"}if(!elem.checked){delete m[elem.value]}else{m[elem.value]=1}if(elem.value==all){$('input[name="s_mods[]"]',menu).not(elem).map((function(){this.checked=true;if(elem.checked){this.disabled=true;delete m[this.value]}else{this.disabled=false;m[this.value]=1}}))}rcmail.set_searchmods(m)}function spellmenu(obj){var i,link,li,list=[],lang=rcmail.spellcheck_lang(),ul=$("ul",obj);if(!ul.length){ul=$('<ul class="selectable listing iconized" role="menu">');for(i in rcmail.env.spell_langs){li=$('<li role="menuitem">');link=$('<a href="#'+i+'" tabindex="0"></a>').text(rcmail.env.spell_langs[i]).addClass("active").data("lang",i).on("click keypress",(function(e){if(e.type!="keypress"||rcube_event.get_keycode(e)==13){rcmail.spellcheck_lang_set($(this).data("lang"));rcmail.hide_menu("spell-menu",e);return false}}));link.appendTo(li);list.push(li)}ul.append(list).appendTo(obj)}$("li",ul).each((function(){var el=$("a",this);if(el.data("lang")==lang){el.addClass("selected").attr("aria-selected","true")}else if(el.hasClass("selected")){el.removeClass("selected").removeAttr("aria-selected")}}))}function compose_status(id,status){var bar=$("#composestatusbar"),ico=bar.find("a.button.icon."+id);if(!status){ico.remove()}else if(!ico.length){$("<a>").attr("class","button icon "+id).on("click",(function(){show_sidebar()})).appendTo(bar)}}function attachmentmenu(obj,button,event){var id=$(button).parent().attr("id").replace(/^attach/,"");$.each(["open","download","rename"],(function(){var action=this;$("#attachmenu"+action,obj).off("click").attr("onclick","").click((function(e){return rcmail.command(action+"-attachment",id,this,e.originalEvent)}))}));return rcmail.command("menu-open",{menu:"attachmentmenu",id:id},obj,event)}function attachmentmenu_append(item){item=$(item);if(!item.is(".no-menu")&&!item.children(".dropdown").length){var label=rcmail.gettext("options"),fname=item.find("a.filename");var button=$("<a>").attr({href:"#",tabindex:fname.attr("tabindex")||0,title:label,class:"button icon dropdown skip-content"}).on("click",(function(e){return attachmentmenu($("#attachmentmenu"),button,e)})).append($("<span>").attr("class","inner").text(label));if(fname.length){button.insertAfter(fname)}else{button.appendTo(item)}}}function mailtomenu(obj,button,event,onclick){var mailto=$(button).attr("href").replace(/^mailto:/,"");if(mailto.indexOf("@")<0){return true}obj.find("a").off("click").removeClass("active");if(rcmail.env.has_writeable_addressbook){$(".addressbook",obj).addClass("active").on("click",(function(e){var i,contact=mailto,txt=$(button).filter(".rcmContactAddress").text();contact=contact.split("?")[0].split(",")[0].replace(/(^<|>$)/g,"");if(txt){txt=txt.replace("<"+contact+">","");contact='"'+txt.trim()+'" <'+contact+">"}return rcmail.command("add-contact",contact,this,e.originalEvent)}))}$(".compose",obj).addClass("active").on("click",(function(e){if(onclick){button.onclick=onclick;$(button).trigger("click",[true]);button.onclick=null}else{rcmail.command("compose",mailto,this,e.originalEvent)}return false}));return rcmail.command("menu-open",{menu:"mailto-menu",link:button},button,event.originalEvent)}function mailtomenu_append(item){var onclick=item.onclick;item.onclick=null;$(item).on("click",(function(e,menu){return menu||mailtomenu($("#mailto-menu"),item,e,onclick)}))}function headersmenu(obj,button,event){$("li > a",obj).each((function(){var link=$(this),target="#compose_"+link.data("target");link[$(target).is(":visible")?"removeClass":"addClass"]("active").off().on("click",(function(){$(target).removeClass("hidden").find(".recipient-input input").focus();link.removeClass("active");rcmail.set_menu_buttons()}))}))}function header_reset(id){$("#"+id).val("").change().closest(".form-group").nextAll(":not(.hidden)").first().find("input").focus();$("a[data-target="+id.replace(/^_/,"")+"]").addClass("active");rcmail.set_menu_buttons()}function recipient_selector(field,opts){if(!opts)opts={};var title=rcmail.gettext(opts.title||"insertcontact"),dialog=$("#recipient-dialog"),parent=dialog.parent(),close_func=function(){if(dialog.is(":visible")){rcmail.env.recipient_dialog.dialog("close")}},insert_func=function(){if(opts.action){opts.action();close_func();return}rcmail.command("add-recipient")};if(!rcmail.env.recipient_selector_initialized){rcmail.addEventListener("add-recipient",close_func);rcmail.env.recipient_selector_initialized=true}if(field){rcmail.env.focused_field="#_"+field}rcmail.contact_list.clear_selection();rcmail.contact_list.multiselect="multiselect"in opts?opts.multiselect:true;rcmail.env.recipient_dialog=rcmail.simple_dialog(dialog,title,insert_func,{button:rcmail.gettext(opts.button||"insert"),button_class:opts.button_class||"insert recipient",height:600,classes:{"ui-dialog-content":"p-0"},open:function(){$("#directorylist a").first().focus()},close:function(){dialog.appendTo(parent);$(this).remove();$(opts.focus||rcmail.env.focused_field).focus()}})}function update_quota(p){var element=$("#quotadisplay"),bar=element.find(".bar"),value=p.total?p.percent:0;if(!bar.length){bar=$('<span class="bar"><span class="value"></span></span>').appendTo(element)}if(value>0&&value<10){value=10}bar.find(".value").css("width",value+"%")[value>=90?"addClass":"removeClass"]("warning");element.attr({"data-original-title":"",title:element.find(".count").attr("title")});if(p.table){element.css("cursor","pointer").data("popup-pos","top").off("click").on("click",(function(e){rcmail.simple_dialog(p.table,"quota",null,{cancel_button:"close"})}))}else{element.tooltip("dispose").tooltip({trigger:is_mobile()?"click":"hover"})}}function recipient_input(obj){var list,input,selection="",apply_func=function(){$(obj).val(list.text()+input.val())},insert_recipient=function(name,email,replace){var recipient=$('<li class="recipient">'),name_element=$('<span class="name">').html(recipient_input_name(name||email)).on("dblclick",(function(e){recipient_input_edit_dialog(e,insert_recipient)})),email_element=$('<span class="email">'),link=$("<a>").attr({class:"button icon remove"}).click((function(){recipient.remove();apply_func();input.focus();return false}));if(name){email=" <"+email+">"}email_element.text((name?email:"")+",");recipient.attr("title",name?name+email:null).append([name_element,email_element,link]);if(replace)replace.replaceWith(recipient);else recipient.insertBefore(input.parent());apply_func()},update_func=function(text){var result;text=(text||input.val()).replace(/[,;\s]+$/,"");result=recipient_input_parser(text);$.each(result.recipients,(function(){insert_recipient(this.name,this.email)}));input.val(result.text);apply_func();return result.recipients.length>0},parse_func=function(e,ac,trigger){var last,paste,value=this.value;if(trigger===false){return}if(e.type=="paste"){paste=(e.originalEvent.clipboardData||window.clipboardData).getData("text")||"";value=value.substring(0,this.selectionStart)+paste+value.substring(this.selectionEnd);e.preventDefault()}else if(ac){last=list.find("li.recipient").last();if(last.length&&this.value.indexOf(last.text().replace(/[ ,]+$/,""))>-1){last.remove()}}update_func(value)},keydown_func=function(e){if(e.keyCode==8&&!input.val().length){list.children("li.recipient").last().remove();apply_func();return false}else if(e.key==" "||e.key==","||e.key==";"||e.key=="Enter"&&!rcmail.ksearch_visible()){if(update_func()){return false}}};input=$("<input>").attr({type:"text",tabindex:$(obj).attr("tabindex")}).on("paste change",parse_func).on("keydown",keydown_func).on("blur",(function(){list.removeClass("focus")})).on("focus mousedown",(function(){list.addClass("focus")}));list=$("<ul>").addClass("form-control recipient-input ac-input rounded-left").append($('<li class="input">').append(input)).on("mouseup",(function(){selection=window.getSelection().toString()})).on("click",(function(){if(!selection.length)input.focus()})).sortable({appendTo:document.body,items:"> .recipient",connectWith:".recipient-input",receive:function(event,ui){var recipient=list.text();list.find(".recipient").remove();update_func(recipient);if(ui.sender){ui.sender.find("input").change()}}});$(obj).css({position:"absolute",opacity:0,left:"-5000px",width:"10px"}).attr("tabindex",-1).after(list).on("focus",(function(e){input.focus();e.preventDefault()})).on("change",(function(){$("li.recipient",list).remove();input.val(this.value).change()})).change();rcmail.init_address_input_events(input)}function recipient_input_parser(text){text=text.replace(/[,;\s]*[\r\n]+/g,",").trim();var recipients=[],address_rx_part='(\\S+|("[^"]+"))@\\S+',recipient_rx1=new RegExp("(<"+address_rx_part+">)"),recipient_rx2=new RegExp("("+address_rx_part+")"),global_rx=/(?=\S)[^",;]*(?:"[^\\"]*(?:\\[,;\S][^\\"]*)*"[^",;]*)*/g,matches=text.match(global_rx);$.each(matches||[],(function(){if(this.length&&(recipient_rx1.test(this)||recipient_rx2.test(this))){var email,str=this;text=text.replace(str,"");while(str.length&&str.indexOf(RegExp.$1)===0){email=RegExp.$1;recipients.push({name:"",email:email.replace(/(^<|>$)/g,"").replace(/[^a-z]$/gi,"")});str=str.replace(email,"").trim();if(!recipient_rx1.test(str)&&!recipient_rx2.test(str)){break}}if(email!=RegExp.$1&&RegExp.$1){email=RegExp.$1;recipients.push({name:str.replace(email,"").trim(),email:email.replace(/(^<|>$)/g,"")})}}}));text=text.replace(/[,;]+/,",").replace(/^[,;\s]+/,"");return{recipients:recipients,text:text}}function recipient_input_name(text){var i,char,result="",len=text.length;if(text.charAt(0)!='"'&&text.indexOf('"')>-1){text='"'+text.replace("\\","\\\\").replace('"','\\"')+'"'}for(i=0;i<len;i++){char=text.charAt(i);switch(char){case'"':if(i>0&&i<len-1){result+='"';break}result+='<span class="quotes">'+char+"</span>";break;case"\\":result+='<span class="quotes">'+char+"</span>";if(text.charAt(i+1)=="\\"){result+=char;i++}break;case"<":result+="&lt;";break;case">":result+="&gt;";break;default:result+=char}}return result}function recipient_input_edit_dialog(e,callback){var element=$(e.target).parents(".recipient"),recipient=element.text().replace(/,+$/,""),input=$("<input>").attr({type:"text","data-submit":"true"}).val(recipient),content=$("<label>").text(rcmail.gettext("recipient")).append(input);rcmail.simple_dialog(content,"recipientedit",(function(){var result,value=input.val();if(value){if(value!=recipient){result=recipient_input_parser(value);if(result.recipients.length!=1){return false}callback(result.recipients[0].name,result.recipients[0].email,element)}return true}}))}function image_upload_input(obj){var reset_button=$("<a>").attr({class:"icon button delete",href:"#"}).click((function(e){rcmail.command("delete-photo","",this,e);return false})),img=$(obj).find("img")[0],img_onload=function(){var state=(img.currentSrc||img.src).indexOf(rcmail.env.photo_placeholder)!=-1;$(obj)[state?"removeClass":"addClass"]("changed")};$(obj).append(reset_button).click((function(){rcmail.upload_input("upload-form")}));img_onload();$(img).on("load",img_onload)}function iframe_loader(frame){frame=$(frame);if(frame.length){var loader=$('<div class="iframe-loader">').append($('<div class="spinner spinner-border" role="status">').append($('<span class="sr-only">').text(rcmail.gettext("loading"))));frame.on("load error loaded",(function(){setTimeout((function(){loader.remove()}),500)})).parent().append(loader);if(ios){frame.parent().addClass("ios-scroll")}}}function pretty_checkbox(checkbox){var label,parent,id;checkbox=$(checkbox);if(checkbox.is(".custom-control-input")){return}if(!(id=checkbox.attr("id"))){id="icochk"+ ++env.checkboxes;checkbox.attr("id",id)}if(checkbox.parent().is("label")){label=checkbox.parent();checkbox=checkbox.detach();label.before(checkbox)}else{label=$("<label>")}label.attr({for:id,class:"custom-control-label",title:checkbox.attr("title")||""}).on("click",(function(e){e.stopPropagation()}));checkbox.addClass("form-check-input custom-control-input").wrap('<div class="custom-control custom-switch">').parent().append(label)}function pretty_checkbox_fix(params){var id,input=$(params.row).find("input[id^=icochk]");if(input.length){id="icochk"+ ++env.checkboxes;input.attr("id",id).next("label").attr("for",id)}}function pretty_select(select){if(bw.iphone||bw.ipad){return}select=$(select);if(select.is(".pretty-select")){return}var select_ident="select"+select.attr("id")+select.attr("name");var is_menu_open=function(){var win=select[0].ownerDocument.defaultView;if(win.$(".select-menu .listing").data("ident")==select_ident){return true}};var close_func=function(){var open=is_menu_open();select.popover("dispose").focus();return!open};var open_func=function(e){var last_char,last_index=-1,items=[],index=[],dialog=select.closest(".ui-dialog")[0],max_height=(document.documentElement.clientHeight||$(document.body).height())-75,max_width=$(document.body).width()-20,min_width=Math.min(select.outerWidth(),max_width),value=select.val();if(!is_mobile()){max_height*=.5}popups_close(e);$("option",select).each((function(){var label=$(this).text(),link=$('<a href="#">').data("value",this.value).addClass(this.disabled?"disabled":"active"+(this.value==value?" selected":""));if(label.length){link.text(label);index.push(this.disabled?"":label.charAt(0).toLowerCase())}else{link.html("&nbsp;");index.push("")}items.push($("<li>").append(link))}));var list=$('<ul class="listing selectable iconized">').attr("data-ident",select_ident).data("button",select[0]).append(items).on("click","a.active",(function(){var val=$(this).data("value"),ret=close_func();select.val(val).change();return ret})).on("keydown","a.active",(function(e){var item,char,last,node,mode="next";switch(e.which){case 27:case 9:return close_func();case 13:case 32:$(this).click();return false;case 38:case 63232:mode="previous";case 40:case 63233:item=e.target.parentNode;while(item=item[mode+"Sibling"]){if(node=$(item).children(".active")[0]){node.focus();break}}return false;default:char=e.originalEvent.key;if(char&&char.length==1){char=char.toLowerCase();if(last_char!=char){last_index=-1}last=index.indexOf(char,last_index+1);if(last>-1||(last=index.indexOf(char))>-1){list.find("a").eq(last).focus()}last_char=char;last_index=last}}}));select.popover("dispose").popover({container:dialog||document.body,content:list[0],placement:"bottom",trigger:"manual",boundary:"viewport",html:true,offset:"0,2",sanitize:false,template:'<div class="popover select-menu" style="min-width: '+min_width+"px; max-width: "+max_width+'px">'+'<div class="popover-header"></div>'+'<div class="popover-body" style="max-height: '+max_height+'px"></div></div>'}).on("shown.bs.popover",(function(){select.focus();list.parent().prev().empty().append($('<a class="button icon cancel">').text(rcmail.gettext("close")).on("click",(function(e){e.stopPropagation();return close_func()})));var selected=list.find("a.selected").first();if(selected.focus().length){var list_parent=list.parent();last_index=list.find("a").index(selected[0]);last_char=index[last_index];if(bw.mz&&last_index>5){list_parent.scrollTop(list_parent.scrollTop()+list_parent.height()/2-20)}}else if(rcube_event.is_keyboard(e)){list.find("a.active").first().focus()}list.on("mousedown",(function(e){e.stopPropagation()}))})).popover("show")};select.addClass("pretty-select custom-select form-control").on("mousedown keydown",(function(e){select=$(e.target);if(select.prop("disabled")){return}if(e.which==9){close_func();return true}if(e.which==27||e.type=="mousedown"&&is_menu_open()){return close_func()}select.focus();select.prop("disabled",true);setTimeout((function(){select.prop("disabled",false)}),0);e.stopPropagation();if(e.type=="mousedown"||e.which==13||e.which==32||e.which==40||e.which==63233){open_func(e);popups_close_lock=(new Date).getTime();return false}}))}function html_editor_init(obj){var sw,is_table=false,editor=$(obj),parent=editor.parent(),plain_btn=$('<a class="mce-i-html" href="#" tabindex="-1"></a>').attr("title",rcmail.gettext("htmltoggle")).on("click",(function(e){if(rcmail.command("toggle-editor",{id:editor.attr("id"),html:true},"",e.originalEvent)){parent.addClass("ishtml")}})).on("keydown",(function(e){if(e.which==9){editor.focus();return false}})),toolbar=$('<div class="editor-toolbar">').append(plain_btn);if(parent.is("td")){sw=$('input[type="checkbox"]',parent.parent().next());is_table=true}else{sw=editor.next("select.hidden")}textarea_autoresize_init(obj);if(sw.length!=1){return}parent.addClass("html-editor");editor.after(toolbar).data("control",sw).on("keydown",(function(e){if(e.altKey&&e.which==121){plain_btn.focus()}}));if(is_table){sw.parents("tr").first().hide();parent.prev().hide();parent.addClass("col-sm-12")}}function textarea_autoresize_init(textarea){var padding,minHeight,resize=function(){if(!textarea.scrollHeight){return setTimeout(resize,250)}if(!padding){padding=parseInt($(textarea).css("padding-top"))+parseInt($(textarea).css("padding-bottom"))+2;minHeight=$(textarea).height()}if(textarea.scrollHeight-padding<=minHeight){return}var scroll_element,scroll_pos=0;$(textarea).parents().each((function(){if(this.scrollTop>0){scroll_element=this;scroll_pos=this.scrollTop;return false}}));var oldHeight=$(textarea).outerHeight();$(textarea).outerHeight(0);var newHeight=Math.max(minHeight,textarea.scrollHeight);$(textarea).outerHeight(oldHeight);if(newHeight!==oldHeight){$(textarea).height(newHeight)}if(scroll_pos){scroll_element.scrollTop=scroll_pos}};$(textarea).on("input",resize).trigger("input")}function smart_field_init(field){var tip,id=field.id+"_list",area=$('<div class="multi-input"><div class="content"></div><div class="invalid-feedback"></div></div>'),list=field.value?field.value.split("\n"):[""];if($("#"+id).length){return}$.each(list,(function(i,v){smart_field_row_add($(".content",area),v,i,field)}));area.attr("id",id);field=$(field);if(field.attr("disabled")){area.hide()}else{field.prop("disabled",true)}if(field.data("hidden")){area.hide()}field.after(area);if(field.hasClass("is-invalid")){area.addClass("is-invalid");$(".invalid-feedback",area).text(field.data("error-msg"))}}function smart_field_row_add(area,value,idx,field,after){var input,elem=$('<div class="input-group">'+'<input type="text" class="form-control">'+'<span class="input-group-append"><a class="icon reset input-group-text" href="#"></a></span>'+"</div>");input=elem.find("input").attr({value:value,name:field.name+"[]",size:$(field).data("size"),title:field.title,placeholder:field.placeholder}).keydown((function(e){if(e.which==13){var elem=smart_field_row_add(area,"",(new Date).getTime(),field,input.parent());$("input",elem).focus()}else if((e.which==8||e.which==46)&&input.val()==""){var parent=input.parent(),siblings=area.children();if(siblings.length>1){if(parent.prev().length){parent.prev().children("input").focus()}else{parent.next().children("input").focus()}parent.remove();return false}}}));elem.find("a.reset").click((function(){var record=$(this.parentNode.parentNode);if(area.children().length>1){$("input",record.next().length?record.next():record.prev()).focus();record.remove()}else{$("input",record).val("").focus()}}));elem.find("input,a").on("focus",(function(){area.addClass("focused")})).on("blur",(function(){area.removeClass("focused")}));if(after){after.after(elem)}else{elem.appendTo(area)}return elem}function smart_field_reset(field,data){var id=field.id+"_list",list=data.length?data:[""],area=$("#"+id).children(".content");area.empty();$.each(list,(function(i,v){smart_field_row_add(area,v,i,field)}))}function form_errors(tips){$.each(tips,(function(){var input=$("#"+this[0]).addClass("is-invalid");if(input.data("type")=="list"){input.data("error-msg",this[2]);$("#"+this[0]+"_list > .invalid-feedback").text(this[2]);return}input.after($('<span class="invalid-feedback">').text(this[2]))}))}function switch_nav_list(obj){var records,height,speed=250,button=$("a",obj),navlist=$(obj).next();if(!navlist.height()){records=$("tr,li",navlist).filter((function(){return this.style.display!="none"}));height=$(records[0]).height()||50;navlist.animate({height:Math.min(5,records.length)*height+1+"px"},speed);button.addClass("collapse").removeClass("expand");$(obj).addClass("expanded")}else{navlist.animate({height:"0"},speed);button.addClass("expand").removeClass("collapse");$(obj).removeClass("expanded")}}function splitter_init(node){var list_id=node.find(".scroller .listing").first().attr("id"),key=rcmail.env.task+"."+(list_id||rcmail.env.action+"."+node.attr("id")),pos=get_pref(key),inverted=node.is(".sidebar-right"),set_width=function(width){node.css({width:Math.max(100,width),flex:"none"})};if(!node[inverted?"prev":"next"]().length){return}$('<div class="column-resizer">').addClass(inverted?"inverted":null).appendTo(node).on("mousedown",(function(e){var ts,splitter=$(this),offset=node.position().left;splitter.addClass("active");document.body.style.userSelect="none";$(document).on("mousemove.resizer",(function(e){clearTimeout(ts);ts=setTimeout((function(){if(inverted){offset=node.position().left}var cursor_position=rcube_event.get_mouse_pos(e).x,width=inverted?node.width()+(offset-cursor_position):cursor_position-offset;set_width(width)}),5)})).on("mouseup.resizer",(function(){$(document).off(".resizer");$("iframe").off(".resizer");document.body.style.userSelect="auto";splitter.removeClass("active");set_pref(key,node.width())}))}));if(pos){set_width(pos)}}function window_open(url,small,toolbar,force_window){var colorFunc=function(body){$(body).css({color:$(document.body).css("color"),backgroundColor:$(document.body).css("background-color")})};var setColor=color_mode=="dark"&&/_task=mail/.test(url)&&/_action=viewsource/.test(url);if(!is_mobile()||force_window===true){if(/_task=mail/.test(url)&&/_action=get/.test(url)){small=true}var win=env.open_window.call(rcmail,url,small,toolbar);if(setColor){$(win).on("load",(function(){colorFunc(win.document.body)}))}return win}url=rcmail.add_url(url,"_framed",1);url=rcmail.add_url(url,"_extwin",1);var label,title="",props={cancel_button:"close",width:768,height:768},frame=$("<iframe>").attr({id:"windowframe",src:url});if(/_action=([a-z_]+)/.test(url)&&(label=rcmail.labels[RegExp.$1])){title=label}if(/_frame=1/.test(url)){props.dialogClass="no-titlebar"}if(setColor){frame.on("load",(function(){colorFunc(frame[0].contentWindow.document.body)}))}rcmail.simple_dialog(frame,title,null,props);return true}function layout_metadata(){if(is_framed){var doc=$(parent.document.documentElement);return{mode:doc[0].className.match(/layout-([a-z]+)/)?RegExp.$1:mode,touch:doc.is(".touch")}}return{mode:mode,touch:touch}}function is_mobile(){var meta=layout_metadata();return meta.mode=="phone"||meta.mode=="small"}function is_touch(){var meta=layout_metadata();return meta.touch}function get_pref(key){if(!prefs){prefs=rcmail.local_storage_get_item("prefs.elastic",{})}if(prefs[key]==null){var cookie=rcmail.get_cookie(key);if(cookie!=null){prefs[key]=cookie;if(rcmail.local_storage_set_item("prefs.elastic",prefs)){rcmail.set_cookie(key,cookie,new Date)}}}return prefs[key]}function set_pref(key,val){prefs[key]=val;if(!rcmail.local_storage_set_item("prefs.elastic",prefs)){rcmail.set_cookie(key,val,false)}}}if(window.rcmail){rcmail.show_menu=function(prop,show,event){var name=typeof prop=="object"?prop.menu:prop,obj=$("#"+name);if(typeof prop=="string"){prop={menu:name}}return rcmail.triggerEvent(show===false?"menu-close":"menu-open",{name:name,obj:obj,props:prop,originalEvent:event})};rcmail.hide_menu=function(name,event){return rcmail.triggerEvent("menu-close",{name:name,props:{menu:name},originalEvent:event})}}else{var rcmail=parent.rcmail,rcube_webmail=parent.rcube_webmail,bw={}}var UI=new rcube_elastic_ui;if($&&$.datepicker){var __newInst=$.datepicker._newInst;$.extend($.datepicker,{_newInst:function(target,inline){var inst=__newInst.call(this,target,inline);if(!inst.inline){UI.datepicker_init(inst.dpDiv)}return inst}})}